#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  keyboard:
    layout: us
  timezone: UTC

  identity:
    hostname: safeschoolos
    username: safeschool
    password: '$6$h.z5izS8L5S6ey.L$ALU4MoWu.dBHgY3WM0Lz07qIfp/9.LwhzcrDxBCzFc06MlVCq8q4QwPXfhR.HT/mlrqSCDWzTLQpP9TSbqaxP1'

  ssh:
    install-server: true
    allow-pw: true
    authorized-keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOkkRNjHpikLaDTxYfBbH4skE3axZGEzr6VAoH4Z+mAS safeschool-edge
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIMhqUXyK/P+vjoUN+7B02uHh6eKVDMFSqu5JoP2kW3L bwatt@safeschool

  storage:
    layout:
      name: lvm

  packages:
    - docker.io
    - docker-compose-v2
    - curl
    - wget
    - git
    - jq
    - net-tools
    - openssh-server
    - ca-certificates
    - ufw
    - fail2ban
    - unattended-upgrades
    - htop
    - logrotate
    - python3
    - sqlite3

  late-commands:
    # --- Docker group and enable ---
    - curtin in-target --target=/target -- usermod -aG docker safeschool
    - curtin in-target --target=/target -- systemctl enable docker

    # --- Create admin user (admin/admin) for initial setup ---
    - curtin in-target --target=/target -- useradd -m -s /bin/bash -G sudo,docker -p '$6$adminadmin123$A2sGPmK6T3itV2j6v.pCE.F1zNHuJ3GJ7FJCbKvFKrn5ss5UGPQuOFfSTUJWwKJCOSWdQVxjbkSVEIdPnXbN4.' admin

    # --- NOPASSWD sudo for safeschool and admin users ---
    - |
      echo 'safeschool ALL=(ALL) NOPASSWD: ALL' > /target/etc/sudoers.d/safeschool
      chmod 0440 /target/etc/sudoers.d/safeschool
    - |
      echo 'admin ALL=(ALL) NOPASSWD: ALL' > /target/etc/sudoers.d/admin
      chmod 0440 /target/etc/sudoers.d/admin

    # --- Create SafeSchool directories ---
    - curtin in-target --target=/target -- mkdir -p /opt/safeschool
    - curtin in-target --target=/target -- mkdir -p /etc/safeschool
    - curtin in-target --target=/target -- mkdir -p /var/log/safeschool
    - curtin in-target --target=/target -- mkdir -p /opt/safeschool/backups/daily
    - curtin in-target --target=/target -- mkdir -p /opt/safeschool/backups/weekly

    # --- Copy scripts from installer media ---
    - |
      for f in first-boot.sh safeschool-motd.sh network-admin.py admin-menu.sh; do
        if [ -f /cdrom/autoinstall/$f ]; then
          cp /cdrom/autoinstall/$f /target/opt/safeschool/$f
          chmod +x /target/opt/safeschool/$f
        fi
      done

    # --- Copy embedded Docker images from installer media ---
    - |
      if [ -d /cdrom/autoinstall/docker-images ]; then
        mkdir -p /target/opt/safeschool/docker-images
        cp -r /cdrom/autoinstall/docker-images/* /target/opt/safeschool/docker-images/
      fi

    # --- Copy deploy/edge files from installer media ---
    - |
      if [ -d /cdrom/autoinstall/deploy-edge ]; then
        mkdir -p /target/opt/safeschool/deploy/edge
        cp -r /cdrom/autoinstall/deploy-edge/* /target/opt/safeschool/deploy/edge/
      fi

    # --- Install first-boot systemd service (pre-generated file, no heredoc) ---
    - |
      if [ -f /cdrom/autoinstall/safeschool-first-boot.service ]; then
        cp /cdrom/autoinstall/safeschool-first-boot.service /target/etc/systemd/system/
      fi
    - curtin in-target --target=/target -- systemctl enable safeschool-first-boot.service

    # --- Install MOTD placeholder (pre-generated file, no heredoc) ---
    - |
      if [ -f /cdrom/autoinstall/99-safeschool-motd ]; then
        cp /cdrom/autoinstall/99-safeschool-motd /target/etc/update-motd.d/99-safeschool
        chmod +x /target/etc/update-motd.d/99-safeschool
      fi
    - chmod -x /target/etc/update-motd.d/10-help-text 2>/dev/null || true
    - chmod -x /target/etc/update-motd.d/50-motd-news 2>/dev/null || true

    # --- Set ownership ---
    - curtin in-target --target=/target -- chown -R safeschool:safeschool /opt/safeschool
    - curtin in-target --target=/target -- chown -R safeschool:safeschool /etc/safeschool
    - curtin in-target --target=/target -- chown -R safeschool:safeschool /var/log/safeschool
