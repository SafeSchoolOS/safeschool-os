generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Organization (Multi-District Support)
// ============================================================================

model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  type        OrgType  @default(DISTRICT)
  parentId    String?  @map("parent_id")
  address     String?
  city        String?
  state       String?
  zip         String?
  phone       String?
  website     String?
  logoUrl     String?  @map("logo_url")
  settings    Json?    // district-wide settings (notification prefs, compliance rules)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent   Organization?  @relation("OrgHierarchy", fields: [parentId], references: [id])
  children Organization[] @relation("OrgHierarchy")
  sites    Site[]

  @@index([parentId])
  @@map("organizations")
}

enum OrgType {
  STATE_AGENCY
  DISTRICT
  CHARTER_NETWORK
  PRIVATE_SYSTEM
}

// ============================================================================
// Site Hierarchy
// ============================================================================

model Site {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id")
  name           String
  district       String
  address        String
  city           String
  state          String
  zip            String
  latitude       Float
  longitude      Float
  timezone       String   @default("America/New_York")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization? @relation(fields: [organizationId], references: [id])
  buildings Building[]
  users     UserSite[]
  alerts    Alert[]
  lockdowns LockdownCommand[]
  doors     Door[]
  accessZones  AccessZone[]
  cardholders  Cardholder[]
  auditLogs AuditLog[]
  visitors  Visitor[]
  buses     Bus[]
  busRoutes BusRoute[]
  studentCards StudentCard[]
  notificationLogs NotificationLog[]
  drills               Drill[]
  reunificationEvents  ReunificationEvent[]
  environmentalSensors EnvironmentalSensor[]
  anonymousTips        AnonymousTip[]
  threatReports        ThreatReport[]
  socialMediaAlerts    SocialMediaAlert[]
  students             Student[]
  escalationRules      EscalationRule[]
  notificationPreferences NotificationPreference[]
  edgeDevice           EdgeDevice?

  @@index([organizationId])
  @@map("sites")
}

model Building {
  id           String  @id @default(uuid())
  siteId       String  @map("site_id")
  name         String
  floors       Int     @default(1)
  floorPlanUrl String? @map("floor_plan_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  site  Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  rooms    Room[]
  doors    Door[]
  students Student[]

  @@map("buildings")
}

model Room {
  id          String   @id @default(uuid())
  buildingId  String   @map("building_id")
  name        String
  number      String
  floor       Int      @default(1)
  type        RoomType @default(CLASSROOM)
  capacity    Int?
  bleBeaconId String?  @map("ble_beacon_id")
  mapX        Float?   @map("map_x")
  mapY        Float?   @map("map_y")
  mapW        Float?   @map("map_w")
  mapH        Float?   @map("map_h")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  building Building  @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  students Student[]

  @@map("rooms")
}

enum RoomType {
  CLASSROOM
  OFFICE
  GYM
  CAFETERIA
  HALLWAY
  ENTRANCE
  OTHER
}

// ============================================================================
// Users
// ============================================================================

model User {
  id              String   @id @default(uuid())
  clerkId         String?  @unique @map("clerk_id")
  email           String   @unique
  passwordHash    String?  @map("password_hash")
  name            String
  role            UserRole
  phone           String?
  wearableDeviceId String? @map("wearable_device_id")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  sites             UserSite[]
  triggeredAlerts   Alert[]           @relation("AlertTriggeredBy")
  acknowledgedAlerts Alert[]          @relation("AlertAcknowledgedBy")
  lockdownsInitiated LockdownCommand[] @relation("LockdownInitiatedBy")
  auditLogs         AuditLog[]
  hostedVisitors    Visitor[]         @relation("VisitorHost")
  notificationPreferences NotificationPreference[]
  cardholder        Cardholder?

  @@map("users")
}

model UserSite {
  userId String @map("user_id")
  siteId String @map("site_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@id([userId, siteId])
  @@map("user_sites")
}

enum UserRole {
  SUPER_ADMIN
  SITE_ADMIN
  OPERATOR
  TEACHER
  FIRST_RESPONDER
  PARENT
}

// ============================================================================
// Alerts — denormalized location for zero-join panic path
// ============================================================================

model Alert {
  id             String      @id @default(uuid())
  siteId         String      @map("site_id")
  level          AlertLevel
  status         AlertStatus @default(TRIGGERED)
  source         AlertSource
  triggeredById  String      @map("triggered_by_id")
  triggeredAt    DateTime    @default(now()) @map("triggered_at")
  acknowledgedById String?   @map("acknowledged_by_id")
  acknowledgedAt DateTime?   @map("acknowledged_at")
  resolvedAt     DateTime?   @map("resolved_at")

  // Denormalized location — no joins during a panic
  buildingId   String  @map("building_id")
  buildingName String  @map("building_name")
  floor        Int?
  roomId       String? @map("room_id")
  roomName     String? @map("room_name")
  zone         String?
  latitude     Float?
  longitude    Float?

  message  String?
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  site           Site              @relation(fields: [siteId], references: [id])
  triggeredBy    User              @relation("AlertTriggeredBy", fields: [triggeredById], references: [id])
  acknowledgedBy User?             @relation("AlertAcknowledgedBy", fields: [acknowledgedById], references: [id])
  dispatchRecords  DispatchRecord[]
  lockdowns        LockdownCommand[]
  notificationLogs NotificationLog[]

  @@index([siteId, status])
  @@index([triggeredAt])
  @@map("alerts")
}

enum AlertLevel {
  MEDICAL
  LOCKDOWN
  ACTIVE_THREAT
  FIRE
  WEATHER
  ALL_CLEAR
  CUSTOM
}

enum AlertStatus {
  TRIGGERED
  ACKNOWLEDGED
  DISPATCHED
  RESPONDING
  RESOLVED
  CANCELLED
}

enum AlertSource {
  WEARABLE
  MOBILE_APP
  WALL_STATION
  DASHBOARD
  AUTOMATED
}

// ============================================================================
// Doors
// ============================================================================

model Door {
  id              String     @id @default(uuid())
  siteId          String     @map("site_id")
  buildingId      String     @map("building_id")
  name            String
  floor           Int        @default(1)
  zone            String?
  status          DoorStatus @default(LOCKED)
  controllerType  String     @map("controller_type") @default("mock")
  controllerId    String     @map("controller_id") @default("")
  isExterior      Boolean    @default(false) @map("is_exterior")
  isEmergencyExit Boolean    @default(false) @map("is_emergency_exit")
  mapX            Float?     @map("map_x")
  mapY            Float?     @map("map_y")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  site            Site               @relation(fields: [siteId], references: [id])
  building        Building           @relation(fields: [buildingId], references: [id])
  zoneAssignments DoorZoneAssignment[]

  @@index([siteId])
  @@index([buildingId])
  @@map("doors")
}

enum DoorStatus {
  LOCKED
  UNLOCKED
  OPEN
  FORCED
  HELD
  UNKNOWN
}

// ============================================================================
// Lockdown Commands
// ============================================================================

model LockdownCommand {
  id           String        @id @default(uuid())
  siteId       String        @map("site_id")
  scope        LockdownScope
  targetId     String        @map("target_id")
  initiatedById String       @map("initiated_by_id")
  initiatedAt  DateTime      @default(now()) @map("initiated_at")
  releasedAt   DateTime?     @map("released_at")
  alertId      String?       @map("alert_id")
  doorsLocked  Int           @default(0) @map("doors_locked")
  doorsFailed  Json?         @map("doors_failed")
  metadata     Json?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  site        Site  @relation(fields: [siteId], references: [id])
  initiatedBy User  @relation("LockdownInitiatedBy", fields: [initiatedById], references: [id])
  alert       Alert? @relation(fields: [alertId], references: [id])

  @@index([siteId])
  @@map("lockdown_commands")
}

enum LockdownScope {
  FULL_SITE
  BUILDING
  FLOOR
  ZONE
}

// ============================================================================
// 911 Dispatch Records
// ============================================================================

model DispatchRecord {
  id             String         @id @default(uuid())
  alertId        String         @map("alert_id")
  method         DispatchMethod
  status         DispatchStatus @default(PENDING)
  sentAt         DateTime       @default(now()) @map("sent_at")
  confirmedAt    DateTime?      @map("confirmed_at")
  failoverUsed   Boolean        @default(false) @map("failover_used")
  failoverMethod DispatchMethod? @map("failover_method")
  responseTimeMs Int?           @map("response_time_ms")
  metadata       Json?
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  alert Alert @relation(fields: [alertId], references: [id])

  @@index([alertId])
  @@map("dispatch_records")
}

enum DispatchMethod {
  RAPIDSОС
  RAVE_911
  SIP_DIRECT
  CELLULAR
  CONSOLE
}

enum DispatchStatus {
  PENDING
  SENT
  RECEIVED
  DISPATCHED
  ON_SCENE
  FAILED
}

// ============================================================================
// Audit Log — compliance trail
// ============================================================================

model AuditLog {
  id        String   @id @default(uuid())
  siteId    String   @map("site_id")
  userId    String?  @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  details   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  site Site  @relation(fields: [siteId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([siteId, createdAt])
  @@index([entity, entityId])
  @@map("audit_logs")
}

// ============================================================================
// Visitor Management
// ============================================================================

model Visitor {
  id           String        @id @default(uuid())
  siteId       String        @map("site_id")
  firstName    String        @map("first_name")
  lastName     String        @map("last_name")
  photo        String?
  idType       String?       @map("id_type")
  idNumberHash String?       @map("id_number_hash")
  purpose      String
  destination  String
  hostUserId   String?       @map("host_user_id")
  status       VisitorStatus @default(PRE_REGISTERED)
  checkedInAt  DateTime?     @map("checked_in_at")
  checkedOutAt DateTime?     @map("checked_out_at")
  badgeNumber  String?       @map("badge_number")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  site       Site              @relation(fields: [siteId], references: [id])
  host       User?             @relation("VisitorHost", fields: [hostUserId], references: [id])
  screening  VisitorScreening?
  cardholder Cardholder?

  @@index([siteId, status])
  @@index([siteId, checkedInAt])
  @@map("visitors")
}

model VisitorScreening {
  id               String   @id @default(uuid())
  visitorId        String   @unique @map("visitor_id")
  sexOffenderCheck String   @map("sex_offender_check") // CLEAR, FLAGGED, ERROR
  watchlistCheck   String   @map("watchlist_check")
  customCheck      String?  @map("custom_check")
  checkedAt        DateTime @map("checked_at")
  createdAt        DateTime @default(now()) @map("created_at")

  visitor Visitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@map("visitor_screenings")
}

enum VisitorStatus {
  PRE_REGISTERED
  CHECKED_IN
  CHECKED_OUT
  DENIED
  FLAGGED
}

// ============================================================================
// Student Transportation
// ============================================================================

model Bus {
  id                  String   @id @default(uuid())
  siteId              String   @map("site_id")
  busNumber           String   @map("bus_number")
  driverId            String?  @map("driver_id")
  capacity            Int      @default(72)
  hasRfidReader       Boolean  @default(false) @map("has_rfid_reader")
  hasPanicButton      Boolean  @default(false) @map("has_panic_button")
  hasCameras          Boolean  @default(false) @map("has_cameras")
  isActive            Boolean  @default(true) @map("is_active")
  currentLatitude     Float?   @map("current_latitude")
  currentLongitude    Float?   @map("current_longitude")
  currentSpeed        Float?   @map("current_speed")
  currentHeading      Float?   @map("current_heading")
  lastGpsAt           DateTime? @map("last_gps_at")
  currentStudentCount Int      @default(0) @map("current_student_count")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  site             Site               @relation(fields: [siteId], references: [id])
  routeAssignments BusRouteAssignment[]
  ridershipEvents  RidershipEvent[]

  @@index([siteId])
  @@map("buses")
}

model BusRoute {
  id                     String   @id @default(uuid())
  siteId                 String   @map("site_id")
  name                   String
  routeNumber            String   @map("route_number")
  scheduledDepartureTime String   @map("scheduled_departure_time")
  scheduledArrivalTime   String   @map("scheduled_arrival_time")
  isAmRoute              Boolean  @default(true) @map("is_am_route")
  isPmRoute              Boolean  @default(false) @map("is_pm_route")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  site             Site               @relation(fields: [siteId], references: [id])
  stops            BusStop[]
  busAssignments   BusRouteAssignment[]
  ridershipEvents  RidershipEvent[]

  @@index([siteId])
  @@map("bus_routes")
}

model BusRouteAssignment {
  id      String @id @default(uuid())
  busId   String @map("bus_id")
  routeId String @map("route_id")

  bus   Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  route BusRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([busId, routeId])
  @@map("bus_route_assignments")
}

model BusStop {
  id            String   @id @default(uuid())
  routeId       String   @map("route_id")
  name          String
  address       String
  latitude      Float
  longitude     Float
  scheduledTime String   @map("scheduled_time")
  stopOrder     Int      @map("stop_order")
  createdAt     DateTime @default(now()) @map("created_at")

  route              BusRoute              @relation(fields: [routeId], references: [id], onDelete: Cascade)
  studentAssignments StudentStopAssignment[]

  @@index([routeId])
  @@map("bus_stops")
}

model StudentCard {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  studentId   String?  @map("student_id")
  studentName String   @map("student_name")
  cardId      String   @unique @map("card_id")
  grade       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  site              Site                  @relation(fields: [siteId], references: [id])
  student           Student?              @relation(fields: [studentId], references: [id])
  stopAssignments   StudentStopAssignment[]
  ridershipEvents   RidershipEvent[]
  parentContacts    ParentContact[]

  @@index([siteId])
  @@index([studentId])
  @@map("student_cards")
}

model StudentStopAssignment {
  id            String @id @default(uuid())
  studentCardId String @map("student_card_id")
  stopId        String @map("stop_id")

  studentCard StudentCard @relation(fields: [studentCardId], references: [id], onDelete: Cascade)
  stop        BusStop     @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@unique([studentCardId, stopId])
  @@map("student_stop_assignments")
}

model RidershipEvent {
  id            String   @id @default(uuid())
  studentCardId String   @map("student_card_id")
  busId         String   @map("bus_id")
  routeId       String   @map("route_id")
  scanType      ScanType @map("scan_type")
  scanMethod    String   @default("RFID") @map("scan_method")
  scannedAt     DateTime @map("scanned_at")
  createdAt     DateTime @default(now()) @map("created_at")

  studentCard StudentCard @relation(fields: [studentCardId], references: [id])
  bus         Bus         @relation(fields: [busId], references: [id])
  route       BusRoute    @relation(fields: [routeId], references: [id])

  @@index([studentCardId, scannedAt])
  @@index([busId, scannedAt])
  @@map("ridership_events")
}

enum ScanType {
  BOARD
  EXIT
}

model ParentContact {
  id            String  @id @default(uuid())
  studentCardId String? @map("student_card_id")
  studentId     String? @map("student_id")
  parentName    String  @map("parent_name")
  relationship  String
  phone         String?
  email         String?
  pushToken     String? @map("push_token")
  boardAlerts   Boolean @default(true) @map("board_alerts")
  exitAlerts    Boolean @default(true) @map("exit_alerts")
  etaAlerts     Boolean @default(true) @map("eta_alerts")
  delayAlerts   Boolean @default(true) @map("delay_alerts")
  missedBusAlerts Boolean @default(true) @map("missed_bus_alerts")
  smsEnabled    Boolean @default(true) @map("sms_enabled")
  emailEnabled  Boolean @default(true) @map("email_enabled")
  pushEnabled   Boolean @default(false) @map("push_enabled")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  studentCard StudentCard? @relation(fields: [studentCardId], references: [id], onDelete: Cascade)
  student     Student?     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentCardId])
  @@index([studentId])
  @@map("parent_contacts")
}

// ============================================================================
// Student Management
// ============================================================================

model Student {
  id             String    @id @default(uuid())
  siteId         String    @map("site_id")
  firstName      String    @map("first_name")
  lastName       String    @map("last_name")
  studentNumber  String    @map("student_number")
  photo          String?
  grade          String?
  dateOfBirth    DateTime? @map("date_of_birth")
  buildingId     String?   @map("building_id")
  roomId         String?   @map("room_id")
  enrollmentDate DateTime? @map("enrollment_date")
  withdrawalDate DateTime? @map("withdrawal_date")
  isActive       Boolean   @default(true) @map("is_active")
  medicalNotes   String?   @map("medical_notes")
  allergies      String?
  notes          String?
  externalId     String?   @map("external_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  site           Site           @relation(fields: [siteId], references: [id])
  building       Building?      @relation(fields: [buildingId], references: [id])
  room           Room?          @relation(fields: [roomId], references: [id])
  transportCards StudentCard[]
  parentContacts ParentContact[]

  @@unique([siteId, studentNumber])
  @@index([siteId, grade])
  @@index([siteId, isActive])
  @@map("students")
}

// ============================================================================
// Notification Log
// ============================================================================

model NotificationLog {
  id             String   @id @default(uuid())
  siteId         String   @map("site_id")
  alertId        String?  @map("alert_id")
  channel        String
  recipientCount Int      @map("recipient_count")
  message        String
  status         String   @default("SENT")
  sentAt         DateTime @map("sent_at")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")

  site  Site   @relation(fields: [siteId], references: [id])
  alert Alert? @relation(fields: [alertId], references: [id])

  @@index([siteId, sentAt])
  @@map("notification_logs")
}

// ============================================================================
// Drill Management (Phase 4)
// ============================================================================

model Drill {
  id              String      @id @default(uuid())
  siteId          String      @map("site_id")
  type            DrillType
  status          DrillStatus @default(SCHEDULED)
  scheduledAt     DateTime    @map("scheduled_at")
  startedAt       DateTime?   @map("started_at")
  completedAt     DateTime?   @map("completed_at")
  initiatedById   String      @map("initiated_by_id")
  buildingId      String?     @map("building_id")
  notes           String?
  evacuationTimeS Int?        @map("evacuation_time_s")
  headCount       Int?        @map("head_count")
  issues          Json?
  complianceMet   Boolean?    @map("compliance_met")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  site         Site              @relation(fields: [siteId], references: [id])
  participants DrillParticipant[]

  @@index([siteId, scheduledAt])
  @@map("drills")
}

model DrillParticipant {
  id        String   @id @default(uuid())
  drillId   String   @map("drill_id")
  name      String
  role      String
  checkedIn Boolean  @default(false) @map("checked_in")
  checkedAt DateTime? @map("checked_at")
  notes     String?

  drill Drill @relation(fields: [drillId], references: [id], onDelete: Cascade)

  @@index([drillId])
  @@map("drill_participants")
}

enum DrillType {
  LOCKDOWN
  FIRE
  EVACUATION
  SHELTER_IN_PLACE
  ACTIVE_THREAT
  REUNIFICATION
  CUSTOM
}

enum DrillStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================================================
// Reunification (Phase 4)
// ============================================================================

model ReunificationEvent {
  id             String              @id @default(uuid())
  siteId         String              @map("site_id")
  alertId        String?             @map("alert_id")
  status         ReunificationStatus @default(ACTIVE)
  location       String
  startedAt      DateTime            @default(now()) @map("started_at")
  completedAt    DateTime?           @map("completed_at")
  totalStudents  Int                 @default(0) @map("total_students")
  reunifiedCount Int                 @default(0) @map("reunified_count")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  site    Site                 @relation(fields: [siteId], references: [id])
  entries ReunificationEntry[]

  @@index([siteId, status])
  @@map("reunification_events")
}

model ReunificationEntry {
  id              String    @id @default(uuid())
  eventId         String    @map("event_id")
  studentName     String    @map("student_name")
  studentGrade    String?   @map("student_grade")
  guardianName    String?   @map("guardian_name")
  guardianIdType  String?   @map("guardian_id_type")
  guardianIdCheck Boolean   @default(false) @map("guardian_id_check")
  releasedAt      DateTime? @map("released_at")
  releasedById    String?   @map("released_by_id")
  status          String    @default("WAITING")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")

  event ReunificationEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, status])
  @@map("reunification_entries")
}

enum ReunificationStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================================================
// Environmental Monitoring (Phase 4)
// ============================================================================

model EnvironmentalSensor {
  id          String       @id @default(uuid())
  siteId      String       @map("site_id")
  buildingId  String?      @map("building_id")
  name        String
  type        SensorType
  location    String
  isOnline    Boolean      @default(true) @map("is_online")
  lastReading DateTime?    @map("last_reading")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  site     Site                   @relation(fields: [siteId], references: [id])
  readings EnvironmentalReading[]

  @@index([siteId, type])
  @@map("environmental_sensors")
}

model EnvironmentalReading {
  id        String   @id @default(uuid())
  sensorId  String   @map("sensor_id")
  value     Float
  unit      String
  isAlert   Boolean  @default(false) @map("is_alert")
  readAt    DateTime @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")

  sensor EnvironmentalSensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)

  @@index([sensorId, readAt])
  @@map("environmental_readings")
}

enum SensorType {
  FIRE_ALARM
  SMOKE_DETECTOR
  CO_DETECTOR
  AIR_QUALITY
  TEMPERATURE
  HUMIDITY
  WEATHER_STATION
  WATER_LEAK
}

// ============================================================================
// Anonymous Tips (Phase 3 backfill)
// ============================================================================

model AnonymousTip {
  id          String    @id @default(uuid())
  siteId      String    @map("site_id")
  category    TipCategory
  message     String
  severity    TipSeverity @default(LOW)
  status      TipStatus   @default(NEW)
  contactInfo String?   @map("contact_info")
  reviewedById String?  @map("reviewed_by_id")
  reviewedAt  DateTime? @map("reviewed_at")
  notes       String?
  ipHash      String?   @map("ip_hash")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
  @@index([siteId, createdAt])
  @@map("anonymous_tips")
}

enum TipCategory {
  BULLYING
  WEAPONS
  THREATS
  DRUGS
  SELF_HARM
  ABUSE
  SUSPICIOUS_ACTIVITY
  OTHER
}

enum TipSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TipStatus {
  NEW
  UNDER_REVIEW
  INVESTIGATING
  RESOLVED
  DISMISSED
}

// ============================================================================
// Behavioral Threat Assessment (Phase 3 backfill)
// ============================================================================

model ThreatReport {
  id              String               @id @default(uuid())
  siteId          String               @map("site_id")
  reportedById    String?              @map("reported_by_id")
  subjectName     String               @map("subject_name")
  subjectGrade    String?              @map("subject_grade")
  subjectRole     String?              @map("subject_role") // student, staff, visitor
  category        ThreatCategory
  description     String
  evidence        Json?
  riskLevel       RiskLevel            @default(LOW)
  status          ThreatReportStatus   @default(REPORTED)
  assignedToId    String?              @map("assigned_to_id")
  actionTaken     String?              @map("action_taken")
  escalatedAt     DateTime?            @map("escalated_at")
  resolvedAt      DateTime?            @map("resolved_at")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
  @@index([siteId, riskLevel])
  @@map("threat_reports")
}

enum ThreatCategory {
  VERBAL_THREAT
  WRITTEN_THREAT
  SOCIAL_MEDIA
  BEHAVIORAL_CHANGE
  WEAPON_POSSESSION
  SELF_HARM
  BULLYING
  DOMESTIC
  SUBSTANCE_ABUSE
  OTHER_CONCERN
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
  IMMINENT
}

enum ThreatReportStatus {
  REPORTED
  UNDER_ASSESSMENT
  INTERVENTION_PLANNED
  INTERVENTION_ACTIVE
  MONITORING
  RESOLVED
  ESCALATED_TO_LE   // Escalated to Law Enforcement
  CLOSED
}

// ============================================================================
// Social Media Monitoring (Phase 3 backfill)
// ============================================================================

model SocialMediaAlert {
  id             String                @id @default(uuid())
  siteId         String                @map("site_id")
  source         SocialMediaSource
  platform       String                // instagram, tiktok, snapchat, twitter, etc.
  contentType    String                @map("content_type") // text, image, video
  flaggedContent String?               @map("flagged_content")
  category       SocialMediaCategory
  severity       TipSeverity           @default(LOW)
  status         SocialMediaAlertStatus @default(NEW)
  studentName    String?               @map("student_name")
  studentGrade   String?               @map("student_grade")
  reviewedById   String?               @map("reviewed_by_id")
  reviewedAt     DateTime?             @map("reviewed_at")
  actionTaken    String?               @map("action_taken")
  externalId     String?               @map("external_id") // ID from monitoring service
  metadata       Json?
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
  @@index([siteId, severity])
  @@map("social_media_alerts")
}

enum SocialMediaSource {
  BARK
  NAVIGATE360
  GAGGLE
  SECURLY
  MANUAL
}

enum SocialMediaCategory {
  VIOLENCE_THREAT
  SELF_HARM_RISK
  BULLYING_CYBER
  DRUG_REFERENCE
  SEXUAL_CONTENT
  HATE_SPEECH
  SCHOOL_THREAT
  WEAPON_REFERENCE
  OTHER
}

enum SocialMediaAlertStatus {
  NEW
  REVIEWING
  CONFIRMED
  FALSE_POSITIVE
  ESCALATED
  RESOLVED
}

// ============================================================================
// ============================================================================
// Notification Preferences (Per-User)
// ============================================================================

model NotificationPreference {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  siteId     String   @map("site_id")
  channel    String   // SMS, EMAIL, PUSH
  alertLevel String   @map("alert_level") // MEDICAL, LOCKDOWN, ACTIVE_THREAT, FIRE, WEATHER, ALL_CLEAR
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([userId, siteId, channel, alertLevel])
  @@index([userId, siteId])
  @@map("notification_preferences")
}

// ============================================================================
// Demo Requests (Marketing Landing Page)
// ============================================================================

model DemoRequest {
  id         String   @id @default(uuid())
  name       String
  email      String
  school     String
  role       String
  phone      String?
  buildings  Int?
  state      String?
  message    String?
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("demo_requests")
}

// ============================================================================
// Escalation Rules (Configurable Alert Escalation)
// ============================================================================

model EscalationRule {
  id           String   @id @default(uuid())
  siteId       String   @map("site_id")
  name         String
  alertLevel   String   @map("alert_level")
  delayMinutes Int      @map("delay_minutes")
  action       String   // NOTIFY_ROLES, AUTO_LOCKDOWN, AUTO_DISPATCH, ESCALATE_LEVEL
  targetRoles  String[] @map("target_roles")
  targetLevel  String?  @map("target_level")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, alertLevel])
  @@map("escalation_rules")
}

// ============================================================================
// Edge Device Fleet Management
// ============================================================================

model EdgeDevice {
  id               String        @id @default(uuid())
  siteId           String        @unique @map("site_id")
  currentVersion   String?       @map("current_version")
  targetVersion    String?       @map("target_version")
  operatingMode    String?       @map("operating_mode") // EDGE, STANDALONE
  pendingChanges   Int           @default(0) @map("pending_changes")
  upgradeStatus    UpgradeStatus @default(IDLE) @map("upgrade_status")
  upgradeError     String?       @map("upgrade_error")
  hostname         String?
  ipAddress        String?       @map("ip_address")
  nodeVersion      String?       @map("node_version")
  diskUsagePercent Float?        @map("disk_usage_percent")
  memoryUsageMb    Float?        @map("memory_usage_mb")
  lastHeartbeatAt  DateTime      @default(now()) @map("last_heartbeat_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([upgradeStatus])
  @@map("edge_devices")
}

enum UpgradeStatus {
  IDLE
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
}

// ============================================================================
// Access Control — Cardholders, Credentials & Zones
// ============================================================================

model AccessZone {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  name        String
  description String?
  externalId  String?  @map("external_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  site            Site                      @relation(fields: [siteId], references: [id])
  doorAssignments DoorZoneAssignment[]
  credentials     CredentialZoneAssignment[]

  @@unique([siteId, name])
  @@index([siteId])
  @@map("access_zones")
}

model DoorZoneAssignment {
  id     String @id @default(uuid())
  doorId String @map("door_id")
  zoneId String @map("zone_id")

  door Door       @relation(fields: [doorId], references: [id], onDelete: Cascade)
  zone AccessZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([doorId, zoneId])
  @@map("door_zone_assignments")
}

model Cardholder {
  id         String     @id @default(uuid())
  siteId     String     @map("site_id")
  personType PersonType @map("person_type")
  firstName  String     @map("first_name")
  lastName   String     @map("last_name")
  email      String?
  phone      String?
  company    String?
  title      String?
  userId     String?    @unique @map("user_id")
  visitorId  String?    @unique @map("visitor_id")
  externalId String?    @map("external_id")
  photo      String?
  isActive   Boolean    @default(true) @map("is_active")
  notes      String?
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  site        Site                  @relation(fields: [siteId], references: [id])
  user        User?                 @relation(fields: [userId], references: [id])
  visitor     Visitor?              @relation(fields: [visitorId], references: [id])
  credentials CardholderCredential[]

  @@index([siteId, personType])
  @@index([siteId, isActive])
  @@map("cardholders")
}

model CardholderCredential {
  id             String           @id @default(uuid())
  cardholderId   String           @map("cardholder_id")
  credentialType CredentialType   @map("credential_type")
  status         CredentialStatus @default(ACTIVE)
  cardNumber     String?          @map("card_number")
  facilityCode   String?          @map("facility_code")
  externalId     String?          @map("external_id")
  issuedAt       DateTime         @default(now()) @map("issued_at")
  expiresAt      DateTime?        @map("expires_at")
  revokedAt      DateTime?        @map("revoked_at")
  revokedReason  String?          @map("revoked_reason")
  lastUsedAt     DateTime?        @map("last_used_at")
  metadata       Json?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  cardholder Cardholder               @relation(fields: [cardholderId], references: [id], onDelete: Cascade)
  zones      CredentialZoneAssignment[]

  @@index([cardholderId])
  @@index([status])
  @@map("cardholder_credentials")
}

model CredentialZoneAssignment {
  id           String @id @default(uuid())
  credentialId String @map("credential_id")
  zoneId       String @map("zone_id")

  credential CardholderCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)
  zone       AccessZone           @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([credentialId, zoneId])
  @@map("credential_zone_assignments")
}

enum PersonType {
  STAFF
  STUDENT
  WORKER
  VISITOR
}

enum CredentialType {
  PHYSICAL_CARD
  MOBILE
  TEMPORARY_CARD
  FOB
}

enum CredentialStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  REVOKED
}
