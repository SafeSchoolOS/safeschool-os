generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Organization (Multi-District Support)
// ============================================================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  type      OrgType  @default(DISTRICT)
  parentId  String?  @map("parent_id")
  address   String?
  city      String?
  state     String?
  zip       String?
  phone     String?
  website   String?
  logoUrl   String?  @map("logo_url")
  settings  Json? // district-wide settings (notification prefs, compliance rules)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent   Organization?  @relation("OrgHierarchy", fields: [parentId], references: [id])
  children Organization[] @relation("OrgHierarchy")
  sites    Site[]

  @@index([parentId])
  @@map("organizations")
}

enum OrgType {
  STATE_AGENCY
  DISTRICT
  CHARTER_NETWORK
  PRIVATE_SYSTEM
}

// ============================================================================
// Site Hierarchy
// ============================================================================

model Site {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id")
  name           String
  district       String
  address        String
  city           String
  state          String
  zip            String
  latitude       Float
  longitude      Float
  timezone       String   @default("America/New_York")
  logoUrl        String?  @map("logo_url")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization            Organization?            @relation(fields: [organizationId], references: [id])
  buildings               Building[]
  users                   UserSite[]
  alerts                  Alert[]
  lockdowns               LockdownCommand[]
  doors                   Door[]
  accessZones             AccessZone[]
  cardholders             Cardholder[]
  auditLogs               AuditLog[]
  visitors                Visitor[]
  buses                   Bus[]
  busRoutes               BusRoute[]
  studentCards            StudentCard[]
  notificationLogs        NotificationLog[]
  drills                  Drill[]
  reunificationEvents     ReunificationEvent[]
  environmentalSensors    EnvironmentalSensor[]
  anonymousTips           AnonymousTip[]
  threatReports           ThreatReport[]
  socialMediaAlerts       SocialMediaAlert[]
  students                Student[]
  escalationRules         EscalationRule[]
  notificationPreferences NotificationPreference[]
  edgeDevice              EdgeDevice?
  // First Responder Module relations
  schoolAgencyLinks       SchoolAgencyLink[]
  incidents               Incident[]
  floorPlans              FloorPlan[]
  dataPackages            DataPackage[]
  frReunificationSites    FRReunificationSite[]
  stagingAreas            StagingArea[]
  keyHolders              KeyHolder[]
  hazardLocations         HazardLocation[]
  frReunificationEvents   FRReunificationEvent[]
  frTips                  FRTip[]
  gateways                Gateway[]
  gatewayFailoverEvents   GatewayFailoverEvent[]
  events                  Event[]
  doorHealthEvents        DoorHealthEvent[]
  workOrders              WorkOrder[]
  actionConfirmations     ActionConfirmation[]
  rollCalls               RollCall[]
  integrationHealths      IntegrationHealth[]
  visitorBans             VisitorBan[]
  visitorPolicies         VisitorPolicy[]
  visitorGroups           VisitorGroup[]
  visitorSettings         SiteVisitorSettings?
  fireAlarmZones          FireAlarmZone[]
  fireAlarmEvents         FireAlarmEvent[]
  evacuationRoutes        EvacuationRoute[]
  badgeKioskIntegration   BadgeKioskIntegration?
  badgeGuardIntegration   BadgeGuardIntegration?
  // Threat Assessment Workflow
  threatAssessmentTeamMembers ThreatAssessmentTeamMember[]
  threatAssessmentNotes       ThreatAssessmentNote[]
  threatAssessmentInterviews  ThreatAssessmentInterview[]
  safetyPlans                 SafetyPlan[]
  // Drill Management
  drillTemplates              DrillTemplate[]
  drillObservations           DrillObservation[]
  drillScores                 DrillScore[]
  recurringDrillSchedules     RecurringDrillSchedule[]
  // Substitute & Contractor Tracking
  dailyAccessPasses           DailyAccessPass[]
  staffTrainingRecords        StaffTrainingRecord[]
  // Student Wellness Check-In
  wellnessCheckIns            WellnessCheckIn[]
  wellnessSchedules           WellnessSchedule[]
  wellnessInterventions       WellnessIntervention[]
  // Attendance via Badge Access
  attendanceRecords           AttendanceRecord[]
  attendanceScans             AttendanceScan[]
  attendanceConfig            AttendanceConfig?
  // Post-Incident AAR
  afterActionReports          AfterActionReport[]
  correctiveActions           CorrectiveAction[]
  // Audio Monitoring
  audioSensors                AudioSensor[]
  audioDetectionEvents        AudioDetectionEvent[]
  audioMonitorConfig          AudioMonitorConfig?
  // Speech / Verbal Keyword Detection
  speechKeywordProfiles       SpeechKeywordProfile[]
  speechDetectionEvents       SpeechDetectionEvent[]
  speechDetectionConfig       SpeechDetectionConfig?
  // Scheduled Door Locks
  classSchedules              ClassSchedule[]
  doorLockSchedules           DoorLockSchedule[]
  doorScheduleOverrides       DoorScheduleOverride[]
  // Emergency Supply Tracking
  emergencySupplies           EmergencySupply[]
  supplyInspections           SupplyInspection[]
  supplyUsageLogs             SupplyUsageLog[]
  // Staff Certifications
  staffCertifications         StaffCertification[]
  certRequirements            CertRequirement[]
  // Compliance Auto-Alerts
  complianceAlerts            ComplianceAlert[]
  complianceCheckSchedules    ComplianceCheckSchedule[]
  // Video Intercom
  intercomDevices             IntercomDevice[]
  intercomSessions            IntercomSession[]
  // Perimeter Security
  perimeterSensors            PerimeterSensor[]
  perimeterEvents             PerimeterEvent[]
  vehicleWhitelist            VehicleWhitelist[]
  // BLE Beacon Location Tracking
  bleBeacons                  BLEBeacon[]
  locationPings               LocationPing[]
  locationSnapshots           LocationSnapshot[]
  // AI Video Analytics
  videoAnalyticsConfig        VideoAnalyticsConfig?
  videoAnalyticsEvents        VideoAnalyticsEvent[]

  @@index([organizationId])
  @@map("sites")
}

model Building {
  id           String   @id @default(uuid())
  siteId       String   @map("site_id")
  name         String
  floors       Int      @default(1)
  floorPlanUrl String?  @map("floor_plan_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  site             Site              @relation(fields: [siteId], references: [id], onDelete: Cascade)
  rooms            Room[]
  doors            Door[]
  students         Student[]
  floorPlans       FloorPlan[]
  audioSensors     AudioSensor[]
  intercomDevices  IntercomDevice[]
  bleBeacons       BLEBeacon[]

  @@map("buildings")
}

model Room {
  id          String   @id @default(uuid())
  buildingId  String   @map("building_id")
  name        String
  number      String
  floor       Int      @default(1)
  type        RoomType @default(CLASSROOM)
  capacity    Int?
  bleBeaconId String?  @map("ble_beacon_id")
  mapX        Float?   @map("map_x")
  mapY        Float?   @map("map_y")
  mapW        Float?   @map("map_w")
  mapH        Float?   @map("map_h")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  building        Building         @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  students        Student[]
  rollCallReports RollCallReport[]

  @@map("rooms")
}

enum RoomType {
  CLASSROOM
  OFFICE
  GYM
  CAFETERIA
  HALLWAY
  ENTRANCE
  LOADING_DOCK
  MAINTENANCE
  KITCHEN
  MECHANICAL
  STORAGE
  OTHER
}

// ============================================================================
// Users
// ============================================================================

model User {
  id               String   @id @default(uuid())
  clerkId          String?  @unique @map("clerk_id")
  email            String   @unique
  passwordHash     String?  @map("password_hash")
  name             String
  role             UserRole
  phone            String?
  wearableDeviceId String?  @map("wearable_device_id")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  sites                   UserSite[]
  triggeredAlerts         Alert[]                  @relation("AlertTriggeredBy")
  acknowledgedAlerts      Alert[]                  @relation("AlertAcknowledgedBy")
  lockdownsInitiated      LockdownCommand[]        @relation("LockdownInitiatedBy")
  auditLogs               AuditLog[]
  hostedVisitors          Visitor[]                @relation("VisitorHost")
  hostedVisitorGroups     VisitorGroup[]           @relation("VisitorGroupHost")
  notificationPreferences NotificationPreference[]
  cardholder              Cardholder?
  createdEvents           Event[]                  @relation("EventCreatedBy")
  rollCallReports         RollCallReport[]
  visitorBans             VisitorBan[]             @relation("BannedBy")
  // Threat Assessment Workflow
  threatAssessmentTeamMemberships ThreatAssessmentTeamMember[]
  threatAssessmentNotes           ThreatAssessmentNote[]
  threatAssessmentInterviews      ThreatAssessmentInterview[] @relation("InterviewConductedBy")
  safetyPlansCreated              SafetyPlan[]
  // Drill Management
  drillObservations               DrillObservation[]
  drillScoresGiven                DrillScore[]
  // Student Wellness Check-In
  wellnessCheckInsAsCounselor     WellnessCheckIn[]   @relation("WellnessCheckInCounselor")
  wellnessSchedulesAsCounselor    WellnessSchedule[]  @relation("WellnessScheduleCounselor")
  wellnessInterventionsAsCounselor WellnessIntervention[] @relation("WellnessInterventionCounselor")
  // Post-Incident AAR
  afterActionReportsAuthored      AfterActionReport[]  @relation("AARAuthor")
  // Staff Certifications
  staffCertifications             StaffCertification[]

  @@map("users")
}

model UserSite {
  userId String @map("user_id")
  siteId String @map("site_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@id([userId, siteId])
  @@map("user_sites")
}

enum UserRole {
  SUPER_ADMIN
  SITE_ADMIN
  OPERATOR
  TEACHER
  FIRST_RESPONDER
  PARENT
}

// ============================================================================
// Alerts — denormalized location for zero-join panic path
// ============================================================================

model Alert {
  id               String      @id @default(uuid())
  siteId           String      @map("site_id")
  level            AlertLevel
  status           AlertStatus @default(TRIGGERED)
  source           AlertSource
  triggeredById    String      @map("triggered_by_id")
  triggeredAt      DateTime    @default(now()) @map("triggered_at")
  acknowledgedById String?     @map("acknowledged_by_id")
  acknowledgedAt   DateTime?   @map("acknowledged_at")
  resolvedAt       DateTime?   @map("resolved_at")

  // Denormalized location — no joins during a panic
  buildingId   String  @map("building_id")
  buildingName String  @map("building_name")
  floor        Int?
  roomId       String? @map("room_id")
  roomName     String? @map("room_name")
  zone         String?
  latitude     Float?
  longitude    Float?

  message  String?
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  site             Site              @relation(fields: [siteId], references: [id])
  triggeredBy      User              @relation("AlertTriggeredBy", fields: [triggeredById], references: [id])
  acknowledgedBy   User?             @relation("AlertAcknowledgedBy", fields: [acknowledgedById], references: [id])
  dispatchRecords  DispatchRecord[]
  lockdowns        LockdownCommand[]
  notificationLogs NotificationLog[]

  @@index([siteId, status])
  @@index([triggeredAt])
  @@index([siteId, status, triggeredAt]) // covers WHERE siteId+status ORDER BY triggeredAt (alerts list)
  @@map("alerts")
}

enum AlertLevel {
  MEDICAL
  LOCKDOWN
  ACTIVE_THREAT
  FIRE
  WEATHER
  ALL_CLEAR
  CUSTOM
}

enum AlertStatus {
  TRIGGERED
  ACKNOWLEDGED
  DISPATCHED
  RESPONDING
  RESOLVED
  CANCELLED
  SUPPRESSED
}

enum AlertSource {
  WEARABLE
  MOBILE_APP
  WALL_STATION
  DASHBOARD
  AUTOMATED
}

// ============================================================================
// Doors
// ============================================================================

model Door {
  id              String     @id @default(uuid())
  siteId          String     @map("site_id")
  buildingId      String     @map("building_id")
  name            String
  floor           Int        @default(1)
  zone            String?
  status          DoorStatus @default(LOCKED)
  controllerType  String     @default("mock") @map("controller_type")
  controllerId    String     @default("") @map("controller_id")
  isExterior      Boolean    @default(false) @map("is_exterior")
  isEmergencyExit Boolean    @default(false) @map("is_emergency_exit")
  mapX            Float?     @map("map_x")
  mapY            Float?     @map("map_y")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  site              Site                 @relation(fields: [siteId], references: [id])
  building          Building             @relation(fields: [buildingId], references: [id])
  zoneAssignments   DoorZoneAssignment[]
  eventDoorGrants   EventDoorGrant[]
  healthEvents      DoorHealthEvent[]
  workOrders        WorkOrder[]
  doorLockSchedules DoorLockSchedule[]

  @@index([siteId])
  @@index([buildingId])
  @@index([siteId, buildingId, isEmergencyExit]) // lockdown bulk-update filter
  @@map("doors")
}

enum DoorStatus {
  LOCKED
  UNLOCKED
  OPEN
  FORCED
  HELD
  UNKNOWN
}

// ============================================================================
// Lockdown Commands
// ============================================================================

model LockdownCommand {
  id            String        @id @default(uuid())
  siteId        String        @map("site_id")
  scope         LockdownScope
  targetId      String        @map("target_id")
  initiatedById String        @map("initiated_by_id")
  initiatedAt   DateTime      @default(now()) @map("initiated_at")
  releasedAt    DateTime?     @map("released_at")
  alertId       String?       @map("alert_id")
  doorsLocked   Int           @default(0) @map("doors_locked")
  doorsFailed   Json?         @map("doors_failed")
  metadata      Json?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  site        Site   @relation(fields: [siteId], references: [id])
  initiatedBy User   @relation("LockdownInitiatedBy", fields: [initiatedById], references: [id])
  alert       Alert? @relation(fields: [alertId], references: [id])

  @@index([siteId])
  @@map("lockdown_commands")
}

enum LockdownScope {
  FULL_SITE
  BUILDING
  FLOOR
  ZONE
}

// ============================================================================
// 911 Dispatch Records
// ============================================================================

model DispatchRecord {
  id             String          @id @default(uuid())
  alertId        String          @map("alert_id")
  method         DispatchMethod
  status         DispatchStatus  @default(PENDING)
  sentAt         DateTime        @default(now()) @map("sent_at")
  confirmedAt    DateTime?       @map("confirmed_at")
  failoverUsed   Boolean         @default(false) @map("failover_used")
  failoverMethod DispatchMethod? @map("failover_method")
  responseTimeMs Int?            @map("response_time_ms")
  metadata       Json?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  alert Alert @relation(fields: [alertId], references: [id])

  @@index([alertId])
  @@map("dispatch_records")
}

enum DispatchMethod {
  RAPIDSОС
  RAVE_911
  SIP_DIRECT
  CELLULAR
  CONSOLE
}

enum DispatchStatus {
  PENDING
  SENT
  RECEIVED
  DISPATCHED
  ON_SCENE
  FAILED
}

// ============================================================================
// Audit Log — compliance trail
// ============================================================================

model AuditLog {
  id        String   @id @default(uuid())
  siteId    String   @map("site_id")
  userId    String?  @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  details   Json?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  site Site  @relation(fields: [siteId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([siteId, createdAt])
  @@index([entity, entityId])
  @@index([siteId, userId, createdAt]) // user-scoped audit queries
  @@map("audit_logs")
}

// ============================================================================
// Visitor Management
// ============================================================================

model Visitor {
  id           String        @id @default(uuid())
  siteId       String        @map("site_id")
  firstName    String        @map("first_name")
  lastName     String        @map("last_name")
  photo        String?
  idType       String?       @map("id_type")
  idNumberHash String?       @map("id_number_hash")
  purpose      String
  destination  String
  hostUserId   String?       @map("host_user_id")
  status       VisitorStatus @default(PRE_REGISTERED)
  checkedInAt  DateTime?     @map("checked_in_at")
  checkedOutAt DateTime?     @map("checked_out_at")
  badgeNumber  String?       @map("badge_number")
  visitorType  VisitorType   @default(VISITOR) @map("visitor_type")
  email        String?
  phone        String?
  signature    String?
  policyAckedAt DateTime?    @map("policy_acked_at")
  qrToken      String?       @unique @map("qr_token")
  scheduledAt  DateTime?     @map("scheduled_at")
  groupId      String?       @map("group_id")
  companyName  String?       @map("company_name")
  notes          String?
  allowedZoneIds String[]      @default([]) @map("allowed_zone_ids")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  site       Site              @relation(fields: [siteId], references: [id])
  host       User?             @relation("VisitorHost", fields: [hostUserId], references: [id])
  group      VisitorGroup?     @relation(fields: [groupId], references: [id])
  screening  VisitorScreening?
  cardholder Cardholder?

  @@index([siteId, status])
  @@index([siteId, checkedInAt])
  @@map("visitors")
}

model VisitorScreening {
  id               String   @id @default(uuid())
  visitorId        String   @unique @map("visitor_id")
  sexOffenderCheck String   @map("sex_offender_check") // CLEAR, FLAGGED, ERROR
  watchlistCheck   String   @map("watchlist_check")
  customCheck      String?  @map("custom_check")
  checkedAt        DateTime @map("checked_at")
  createdAt        DateTime @default(now()) @map("created_at")

  visitor Visitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@map("visitor_screenings")
}

enum VisitorStatus {
  PRE_REGISTERED
  CHECKED_IN
  CHECKED_OUT
  DENIED
  FLAGGED
}

enum VisitorType {
  VISITOR
  PARENT
  CONTRACTOR
  VENDOR
  VOLUNTEER
  SUBSTITUTE_TEACHER
  DELIVERY
  EMERGENCY_CONTACT
}

model VisitorPolicy {
  id        String   @id @default(uuid())
  siteId    String   @map("site_id")
  title     String
  body      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, isActive])
  @@map("visitor_policies")
}

model VisitorGroup {
  id          String    @id @default(uuid())
  siteId      String    @map("site_id")
  name        String
  purpose     String?
  hostUserId  String?   @map("host_user_id")
  scheduledAt DateTime? @map("scheduled_at")
  totalCount  Int       @default(0) @map("total_count")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  site     Site      @relation(fields: [siteId], references: [id])
  host     User?     @relation("VisitorGroupHost", fields: [hostUserId], references: [id])
  visitors Visitor[]

  @@index([siteId])
  @@map("visitor_groups")
}

model SiteVisitorSettings {
  id                      String  @id @default(uuid())
  siteId                  String  @unique @map("site_id")
  hostNotificationEnabled Boolean @default(true) @map("host_notification_enabled")
  autoCheckoutEnabled     Boolean @default(false) @map("auto_checkout_enabled")
  autoCheckoutTime        String  @default("18:00") @map("auto_checkout_time")
  requireSignature        Boolean @default(false) @map("require_signature")
  requirePhoto            Boolean @default(false) @map("require_photo")
  requirePolicyAck        Boolean @default(false) @map("require_policy_ack")
  publicPreRegEnabled     Boolean @default(false) @map("public_pre_reg_enabled")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@map("site_visitor_settings")
}

// ============================================================================
// Student Transportation
// ============================================================================

model Bus {
  id                  String    @id @default(uuid())
  siteId              String    @map("site_id")
  busNumber           String    @map("bus_number")
  driverId            String?   @map("driver_id")
  capacity            Int       @default(72)
  hasRfidReader       Boolean   @default(false) @map("has_rfid_reader")
  hasPanicButton      Boolean   @default(false) @map("has_panic_button")
  hasCameras          Boolean   @default(false) @map("has_cameras")
  isActive            Boolean   @default(true) @map("is_active")
  currentLatitude     Float?    @map("current_latitude")
  currentLongitude    Float?    @map("current_longitude")
  currentSpeed        Float?    @map("current_speed")
  currentHeading      Float?    @map("current_heading")
  lastGpsAt           DateTime? @map("last_gps_at")
  currentStudentCount Int       @default(0) @map("current_student_count")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  site             Site                 @relation(fields: [siteId], references: [id])
  routeAssignments BusRouteAssignment[]
  ridershipEvents  RidershipEvent[]

  @@index([siteId])
  @@map("buses")
}

model BusRoute {
  id                     String   @id @default(uuid())
  siteId                 String   @map("site_id")
  name                   String
  routeNumber            String   @map("route_number")
  scheduledDepartureTime String   @map("scheduled_departure_time")
  scheduledArrivalTime   String   @map("scheduled_arrival_time")
  isAmRoute              Boolean  @default(true) @map("is_am_route")
  isPmRoute              Boolean  @default(false) @map("is_pm_route")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  site            Site                 @relation(fields: [siteId], references: [id])
  stops           BusStop[]
  busAssignments  BusRouteAssignment[]
  ridershipEvents RidershipEvent[]

  @@index([siteId])
  @@map("bus_routes")
}

model BusRouteAssignment {
  id      String @id @default(uuid())
  busId   String @map("bus_id")
  routeId String @map("route_id")

  bus   Bus      @relation(fields: [busId], references: [id], onDelete: Cascade)
  route BusRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([busId, routeId])
  @@map("bus_route_assignments")
}

model BusStop {
  id            String   @id @default(uuid())
  routeId       String   @map("route_id")
  name          String
  address       String
  latitude      Float
  longitude     Float
  scheduledTime String   @map("scheduled_time")
  stopOrder     Int      @map("stop_order")
  createdAt     DateTime @default(now()) @map("created_at")

  route              BusRoute                @relation(fields: [routeId], references: [id], onDelete: Cascade)
  studentAssignments StudentStopAssignment[]

  @@index([routeId])
  @@map("bus_stops")
}

model StudentCard {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  studentId   String?  @map("student_id")
  studentName String   @map("student_name")
  cardId      String   @unique @map("card_id")
  grade       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  site            Site                    @relation(fields: [siteId], references: [id])
  student         Student?                @relation(fields: [studentId], references: [id])
  stopAssignments StudentStopAssignment[]
  ridershipEvents RidershipEvent[]
  parentContacts  ParentContact[]

  @@index([siteId])
  @@index([studentId])
  @@map("student_cards")
}

model StudentStopAssignment {
  id            String @id @default(uuid())
  studentCardId String @map("student_card_id")
  stopId        String @map("stop_id")

  studentCard StudentCard @relation(fields: [studentCardId], references: [id], onDelete: Cascade)
  stop        BusStop     @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@unique([studentCardId, stopId])
  @@map("student_stop_assignments")
}

model RidershipEvent {
  id            String   @id @default(uuid())
  studentCardId String   @map("student_card_id")
  busId         String   @map("bus_id")
  routeId       String   @map("route_id")
  scanType      ScanType @map("scan_type")
  scanMethod    String   @default("RFID") @map("scan_method")
  scannedAt     DateTime @map("scanned_at")
  createdAt     DateTime @default(now()) @map("created_at")

  studentCard StudentCard @relation(fields: [studentCardId], references: [id])
  bus         Bus         @relation(fields: [busId], references: [id])
  route       BusRoute    @relation(fields: [routeId], references: [id])

  @@index([studentCardId, scannedAt])
  @@index([busId, scannedAt])
  @@map("ridership_events")
}

enum ScanType {
  BOARD
  EXIT
}

model ParentContact {
  id              String   @id @default(uuid())
  studentCardId   String?  @map("student_card_id")
  studentId       String?  @map("student_id")
  parentName      String   @map("parent_name")
  relationship    String
  phone           String?
  email           String?
  pushToken       String?  @map("push_token")
  boardAlerts     Boolean  @default(true) @map("board_alerts")
  exitAlerts      Boolean  @default(true) @map("exit_alerts")
  etaAlerts       Boolean  @default(true) @map("eta_alerts")
  delayAlerts     Boolean  @default(true) @map("delay_alerts")
  missedBusAlerts Boolean  @default(true) @map("missed_bus_alerts")
  smsEnabled      Boolean  @default(true) @map("sms_enabled")
  emailEnabled    Boolean  @default(true) @map("email_enabled")
  pushEnabled     Boolean  @default(false) @map("push_enabled")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  studentCard StudentCard? @relation(fields: [studentCardId], references: [id], onDelete: Cascade)
  student     Student?     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentCardId])
  @@index([studentId])
  @@index([email]) // parent portal email lookup
  @@map("parent_contacts")
}

// ============================================================================
// Student Management
// ============================================================================

model Student {
  id             String    @id @default(uuid())
  siteId         String    @map("site_id")
  firstName      String    @map("first_name")
  lastName       String    @map("last_name")
  studentNumber  String    @map("student_number")
  photo          String?
  grade          String?
  dateOfBirth    DateTime? @map("date_of_birth")
  buildingId     String?   @map("building_id")
  roomId         String?   @map("room_id")
  enrollmentDate DateTime? @map("enrollment_date")
  withdrawalDate DateTime? @map("withdrawal_date")
  isActive       Boolean   @default(true) @map("is_active")
  medicalNotes   String?   @map("medical_notes")
  allergies      String?
  notes          String?
  externalId     String?   @map("external_id")
  badgePrintedAt DateTime? @map("badge_printed_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  site           Site            @relation(fields: [siteId], references: [id])
  building       Building?       @relation(fields: [buildingId], references: [id])
  room           Room?           @relation(fields: [roomId], references: [id])
  transportCards StudentCard[]
  parentContacts ParentContact[]
  // Student Wellness Check-In
  wellnessCheckIns      WellnessCheckIn[]
  wellnessSchedules     WellnessSchedule[]
  wellnessInterventions WellnessIntervention[]
  // Attendance via Badge Access
  attendanceRecords     AttendanceRecord[]

  @@unique([siteId, studentNumber])
  @@index([siteId, grade])
  @@index([siteId, isActive])
  @@index([siteId, buildingId]) // student list filtered by building
  @@index([siteId, roomId]) // student list filtered by room
  @@map("students")
}

// ============================================================================
// Notification Log
// ============================================================================

model NotificationLog {
  id             String   @id @default(uuid())
  siteId         String   @map("site_id")
  alertId        String?  @map("alert_id")
  channel        String
  recipientCount Int      @map("recipient_count")
  message        String
  status         String   @default("SENT")
  sentAt         DateTime @map("sent_at")
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")

  site  Site   @relation(fields: [siteId], references: [id])
  alert Alert? @relation(fields: [alertId], references: [id])

  @@index([siteId, sentAt])
  @@map("notification_logs")
}

// ============================================================================
// Drill Management (Phase 4)
// ============================================================================

model Drill {
  id              String      @id @default(uuid())
  siteId          String      @map("site_id")
  type            DrillType
  status          DrillStatus @default(SCHEDULED)
  scheduledAt     DateTime    @map("scheduled_at")
  startedAt       DateTime?   @map("started_at")
  completedAt     DateTime?   @map("completed_at")
  initiatedById   String      @map("initiated_by_id")
  buildingId      String?     @map("building_id")
  notes           String?
  evacuationTimeS Int?        @map("evacuation_time_s")
  headCount       Int?        @map("head_count")
  issues          Json?
  complianceMet   Boolean?    @map("compliance_met")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  site          Site               @relation(fields: [siteId], references: [id])
  participants  DrillParticipant[]
  // Enhanced drill management relations
  observations  DrillObservation[]
  scores        DrillScore[]
  templateId    String?            @map("template_id")
  template      DrillTemplate?     @relation(fields: [templateId], references: [id])
  recurringScheduleId String?      @map("recurring_schedule_id")
  recurringSchedule   RecurringDrillSchedule? @relation(fields: [recurringScheduleId], references: [id])
  afterActionNotes    String?      @map("after_action_notes")
  afterActionJson     Json?        @map("after_action_json")
  notifiedAt          DateTime?    @map("notified_at")

  @@index([siteId, scheduledAt])
  @@index([siteId, status]) // drill list filtered by status
  @@index([siteId, status, completedAt]) // compliance reporting: completed drills by date range
  @@index([templateId])
  @@index([recurringScheduleId])
  @@map("drills")
}

model DrillParticipant {
  id        String    @id @default(uuid())
  drillId   String    @map("drill_id")
  name      String
  role      String
  checkedIn Boolean   @default(false) @map("checked_in")
  checkedAt DateTime? @map("checked_at")
  notes     String?

  drill Drill @relation(fields: [drillId], references: [id], onDelete: Cascade)

  @@index([drillId])
  @@map("drill_participants")
}

enum DrillType {
  LOCKDOWN
  FIRE
  EVACUATION
  SHELTER_IN_PLACE
  ACTIVE_THREAT
  REUNIFICATION
  CUSTOM
}

enum DrillStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================================================
// Reunification (Phase 4)
// ============================================================================

model ReunificationEvent {
  id             String              @id @default(uuid())
  siteId         String              @map("site_id")
  alertId        String?             @map("alert_id")
  status         ReunificationStatus @default(ACTIVE)
  location       String
  startedAt      DateTime            @default(now()) @map("started_at")
  completedAt    DateTime?           @map("completed_at")
  totalStudents  Int                 @default(0) @map("total_students")
  reunifiedCount Int                 @default(0) @map("reunified_count")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  site    Site                 @relation(fields: [siteId], references: [id])
  entries ReunificationEntry[]

  @@index([siteId, status])
  @@map("reunification_events")
}

model ReunificationEntry {
  id              String    @id @default(uuid())
  eventId         String    @map("event_id")
  studentName     String    @map("student_name")
  studentGrade    String?   @map("student_grade")
  guardianName    String?   @map("guardian_name")
  guardianIdType  String?   @map("guardian_id_type")
  guardianIdCheck Boolean   @default(false) @map("guardian_id_check")
  releasedAt      DateTime? @map("released_at")
  releasedById    String?   @map("released_by_id")
  status          String    @default("WAITING")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")

  event ReunificationEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, status])
  @@map("reunification_entries")
}

enum ReunificationStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================================================
// Environmental Monitoring (Phase 4)
// ============================================================================

model EnvironmentalSensor {
  id          String     @id @default(uuid())
  siteId      String     @map("site_id")
  buildingId  String?    @map("building_id")
  name        String
  type        SensorType
  location    String
  isOnline    Boolean    @default(true) @map("is_online")
  lastReading DateTime?  @map("last_reading")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  site     Site                   @relation(fields: [siteId], references: [id])
  readings EnvironmentalReading[]

  @@index([siteId, type])
  @@map("environmental_sensors")
}

model EnvironmentalReading {
  id        String   @id @default(uuid())
  sensorId  String   @map("sensor_id")
  value     Float
  unit      String
  isAlert   Boolean  @default(false) @map("is_alert")
  readAt    DateTime @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")

  sensor EnvironmentalSensor @relation(fields: [sensorId], references: [id], onDelete: Cascade)

  @@index([sensorId, readAt])
  @@map("environmental_readings")
}

enum SensorType {
  FIRE_ALARM
  SMOKE_DETECTOR
  CO_DETECTOR
  AIR_QUALITY
  TEMPERATURE
  HUMIDITY
  WEATHER_STATION
  WATER_LEAK
}

// ============================================================================
// Anonymous Tips (Phase 3 backfill)
// ============================================================================

model AnonymousTip {
  id           String      @id @default(uuid())
  siteId       String      @map("site_id")
  category     TipCategory
  message      String
  severity     TipSeverity @default(LOW)
  status       TipStatus   @default(NEW)
  contactInfo  String?     @map("contact_info")
  reviewedById String?     @map("reviewed_by_id")
  reviewedAt   DateTime?   @map("reviewed_at")
  notes        String?
  ipHash       String?     @map("ip_hash")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
  @@index([siteId, createdAt])
  @@index([siteId, severity]) // severity-based filtering
  @@map("anonymous_tips")
}

enum TipCategory {
  BULLYING
  WEAPONS
  THREATS
  DRUGS
  SELF_HARM
  ABUSE
  SUSPICIOUS_ACTIVITY
  OTHER
}

enum TipSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TipStatus {
  NEW
  UNDER_REVIEW
  INVESTIGATING
  RESOLVED
  DISMISSED
}

// ============================================================================
// Behavioral Threat Assessment (Phase 3 backfill)
// ============================================================================

model ThreatReport {
  id           String             @id @default(uuid())
  siteId       String             @map("site_id")
  reportedById String?            @map("reported_by_id")
  subjectName  String             @map("subject_name")
  subjectGrade String?            @map("subject_grade")
  subjectRole  String?            @map("subject_role") // student, staff, visitor
  category     ThreatCategory
  description  String
  evidence     Json?
  riskLevel    RiskLevel          @default(LOW)
  status       ThreatReportStatus @default(REPORTED)
  assignedToId String?            @map("assigned_to_id")
  actionTaken  String?            @map("action_taken")
  escalatedAt  DateTime?          @map("escalated_at")
  resolvedAt   DateTime?          @map("resolved_at")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])
  // Threat Assessment Workflow relations
  teamMembers ThreatAssessmentTeamMember[]
  notes       ThreatAssessmentNote[]
  interviews  ThreatAssessmentInterview[]
  safetyPlans SafetyPlan[]
  linkedTips  ThreatReportTipLink[]

  @@index([siteId, status])
  @@index([siteId, riskLevel])
  @@index([siteId, createdAt]) // threat list ordered by date
  @@map("threat_reports")
}

enum ThreatCategory {
  VERBAL_THREAT
  WRITTEN_THREAT
  SOCIAL_MEDIA
  BEHAVIORAL_CHANGE
  WEAPON_POSSESSION
  SELF_HARM
  BULLYING
  DOMESTIC
  SUBSTANCE_ABUSE
  OTHER_CONCERN
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
  IMMINENT
}

enum ThreatReportStatus {
  REPORTED
  UNDER_ASSESSMENT
  INTERVENTION_PLANNED
  INTERVENTION_ACTIVE
  MONITORING
  RESOLVED
  ESCALATED_TO_LE // Escalated to Law Enforcement
  CLOSED
}

// ============================================================================
// Social Media Monitoring (Phase 3 backfill)
// ============================================================================

model SocialMediaAlert {
  id             String                 @id @default(uuid())
  siteId         String                 @map("site_id")
  source         SocialMediaSource
  platform       String // instagram, tiktok, snapchat, twitter, etc.
  contentType    String                 @map("content_type") // text, image, video
  flaggedContent String?                @map("flagged_content")
  category       SocialMediaCategory
  severity       TipSeverity            @default(LOW)
  status         SocialMediaAlertStatus @default(NEW)
  studentName    String?                @map("student_name")
  studentGrade   String?                @map("student_grade")
  reviewedById   String?                @map("reviewed_by_id")
  reviewedAt     DateTime?              @map("reviewed_at")
  actionTaken    String?                @map("action_taken")
  externalId     String?                @map("external_id") // ID from monitoring service
  metadata       Json?
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
  @@index([siteId, severity])
  @@index([siteId, createdAt]) // alert list ordered by date
  @@map("social_media_alerts")
}

enum SocialMediaSource {
  BARK
  NAVIGATE360
  GAGGLE
  SECURLY
  MANUAL
}

enum SocialMediaCategory {
  VIOLENCE_THREAT
  SELF_HARM_RISK
  BULLYING_CYBER
  DRUG_REFERENCE
  SEXUAL_CONTENT
  HATE_SPEECH
  SCHOOL_THREAT
  WEAPON_REFERENCE
  OTHER
}

enum SocialMediaAlertStatus {
  NEW
  REVIEWING
  CONFIRMED
  FALSE_POSITIVE
  ESCALATED
  RESOLVED
}

// ============================================================================
// ============================================================================
// Notification Preferences (Per-User)
// ============================================================================

model NotificationPreference {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  siteId     String   @map("site_id")
  channel    String // SMS, EMAIL, PUSH
  alertLevel String   @map("alert_level") // MEDICAL, LOCKDOWN, ACTIVE_THREAT, FIRE, WEATHER, ALL_CLEAR
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([userId, siteId, channel, alertLevel])
  @@index([userId, siteId])
  @@map("notification_preferences")
}

// ============================================================================
// Demo Requests (Marketing Landing Page)
// ============================================================================

model DemoRequest {
  id         String    @id @default(uuid())
  name       String
  email      String
  school     String
  role       String
  phone      String?
  buildings  Int?
  state      String?
  message    String?
  status     String    @default("PENDING")
  reviewedBy String?   @map("reviewed_by")
  reviewedAt DateTime? @map("reviewed_at")
  notes      String?
  createdAt  DateTime  @default(now()) @map("created_at")

  @@map("demo_requests")
}

// ============================================================================
// Escalation Rules (Configurable Alert Escalation)
// ============================================================================

model EscalationRule {
  id           String   @id @default(uuid())
  siteId       String   @map("site_id")
  name         String
  alertLevel   String   @map("alert_level")
  delayMinutes Int      @map("delay_minutes")
  action       String // NOTIFY_ROLES, AUTO_LOCKDOWN, AUTO_DISPATCH, ESCALATE_LEVEL
  targetRoles  String[] @map("target_roles")
  targetLevel  String?  @map("target_level")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, alertLevel])
  @@map("escalation_rules")
}

// ============================================================================
// Edge Device Fleet Management
// ============================================================================

model EdgeDevice {
  id               String        @id @default(uuid())
  siteId           String        @unique @map("site_id")
  currentVersion   String?       @map("current_version")
  targetVersion    String?       @map("target_version")
  operatingMode    String?       @map("operating_mode") // EDGE, STANDALONE
  pendingChanges   Int           @default(0) @map("pending_changes")
  upgradeStatus    UpgradeStatus @default(IDLE) @map("upgrade_status")
  upgradeError     String?       @map("upgrade_error")
  hostname         String?
  ipAddress        String?       @map("ip_address")
  nodeVersion      String?       @map("node_version")
  diskUsagePercent Float?        @map("disk_usage_percent")
  memoryUsageMb    Float?        @map("memory_usage_mb")
  lastHeartbeatAt  DateTime      @default(now()) @map("last_heartbeat_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([upgradeStatus])
  @@map("edge_devices")
}

enum UpgradeStatus {
  IDLE
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
}

// ============================================================================
// Access Control — Cardholders, Credentials & Zones
// ============================================================================

enum ZoneType {
  PUBLIC
  CLASSROOM
  ADMINISTRATIVE
  SERVICE
  UTILITY
  RESTRICTED
  SECURE
}

model AccessZone {
  id               String   @id @default(uuid())
  siteId           String   @map("site_id")
  name             String
  description      String?
  externalId       String?  @map("external_id")
  type             ZoneType @default(PUBLIC)
  isRestrictedArea Boolean  @default(false) @map("is_restricted_area")
  requiresApproval Boolean  @default(false) @map("requires_approval")
  accessSchedule   Json?    @map("access_schedule")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  site            Site                       @relation(fields: [siteId], references: [id])
  doorAssignments DoorZoneAssignment[]
  credentials     CredentialZoneAssignment[]

  @@unique([siteId, name])
  @@index([siteId])
  @@map("access_zones")
}

model DoorZoneAssignment {
  id     String @id @default(uuid())
  doorId String @map("door_id")
  zoneId String @map("zone_id")

  door Door       @relation(fields: [doorId], references: [id], onDelete: Cascade)
  zone AccessZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([doorId, zoneId])
  @@map("door_zone_assignments")
}

model Cardholder {
  id         String     @id @default(uuid())
  siteId     String     @map("site_id")
  personType PersonType @map("person_type")
  firstName  String     @map("first_name")
  lastName   String     @map("last_name")
  email      String?
  phone      String?
  company    String?
  title      String?
  userId     String?    @unique @map("user_id")
  visitorId  String?    @unique @map("visitor_id")
  externalId String?    @map("external_id")
  photo      String?
  isActive   Boolean    @default(true) @map("is_active")
  notes      String?
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  site        Site                   @relation(fields: [siteId], references: [id])
  user        User?                  @relation(fields: [userId], references: [id])
  visitor     Visitor?               @relation(fields: [visitorId], references: [id])
  credentials CardholderCredential[]

  @@index([siteId, personType])
  @@index([siteId, isActive])
  @@map("cardholders")
}

model CardholderCredential {
  id             String           @id @default(uuid())
  cardholderId   String           @map("cardholder_id")
  credentialType CredentialType   @map("credential_type")
  status         CredentialStatus @default(ACTIVE)
  cardNumber     String?          @map("card_number")
  facilityCode   String?          @map("facility_code")
  pinCode        String?          @map("pin_code")
  cardFormat     String?          @map("card_format")
  externalId     String?          @map("external_id")
  issuedAt       DateTime         @default(now()) @map("issued_at")
  expiresAt      DateTime?        @map("expires_at")
  revokedAt      DateTime?        @map("revoked_at")
  revokedReason  String?          @map("revoked_reason")
  lastUsedAt     DateTime?        @map("last_used_at")
  metadata       Json?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  cardholder Cardholder                 @relation(fields: [cardholderId], references: [id], onDelete: Cascade)
  zones      CredentialZoneAssignment[]

  @@index([cardholderId])
  @@index([status])
  @@index([status, credentialType]) // lockdown: bulk-revoke visitor credentials
  @@map("cardholder_credentials")
}

model CredentialZoneAssignment {
  id           String @id @default(uuid())
  credentialId String @map("credential_id")
  zoneId       String @map("zone_id")

  credential CardholderCredential @relation(fields: [credentialId], references: [id], onDelete: Cascade)
  zone       AccessZone           @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([credentialId, zoneId])
  @@map("credential_zone_assignments")
}

enum PersonType {
  STAFF
  STUDENT
  WORKER
  VISITOR
}

enum CredentialType {
  PHYSICAL_CARD
  MOBILE
  TEMPORARY_CARD
  FOB
}

enum CredentialStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  REVOKED
}

// ============================================================================
// First Responder Module — Agency & Users
// ============================================================================

model Agency {
  id             String       @id @default(uuid())
  name           String
  type           AgencyType
  jurisdiction   String?
  primaryContact String?      @map("primary_contact")
  primaryPhone   String?      @map("primary_phone")
  primaryEmail   String?      @map("primary_email")
  dispatchPhone  String?      @map("dispatch_phone")
  psapId         String?      @map("psap_id")
  rapidSosOrgId  String?      @map("rapid_sos_org_id")
  status         AgencyStatus @default(PENDING_AGENCY)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  users            ResponderUser[]
  schoolLinks      SchoolAgencyLink[]
  incidentAgencies IncidentAgency[]
  escalatedTips    FRTip[]            @relation("TipEscalatedToAgency")

  @@map("agencies")
}

enum AgencyType {
  POLICE
  FIRE
  EMS
  DISPATCH_CENTER
}

enum AgencyStatus {
  ACTIVE_AGENCY
  SUSPENDED_AGENCY
  PENDING_AGENCY
}

model ResponderUser {
  id           String                @id @default(uuid())
  agencyId     String                @map("agency_id")
  badgeNumber  String?               @map("badge_number")
  firstName    String                @map("first_name")
  lastName     String                @map("last_name")
  email        String                @unique
  phone        String?
  passwordHash String                @map("password_hash")
  role         ResponderRole
  permissions  ResponderPermission[]
  mfaEnabled   Boolean               @default(false) @map("mfa_enabled")
  mfaSecret    String?               @map("mfa_secret")
  lastLogin    DateTime?             @map("last_login")
  status       ResponderUserStatus   @default(ACTIVE_RESPONDER)
  createdAt    DateTime              @default(now()) @map("created_at")
  updatedAt    DateTime              @updatedAt @map("updated_at")

  agency               Agency                @relation(fields: [agencyId], references: [id])
  auditEntries         ResponderAuditLog[]
  dataPackageDownloads DataPackageDownload[]
  videoBookmarks       VideoBookmark[]
  // sentMessages accessed via prisma.secureMessage.findMany({ where: { senderId, senderType: 'RESPONDER' } })

  @@index([agencyId])
  @@map("responder_users")
}

enum ResponderRole {
  DISPATCH_ROLE
  PATROL
  COMMAND
  AGENCY_ADMIN
  INVESTIGATOR
}

enum ResponderPermission {
  VIEW_FLOOR_PLANS
  VIEW_DOOR_STATUS
  VIEW_CAMERA_FEEDS
  CONTROL_DOORS
  VIEW_VISITOR_LIST
  VIEW_STUDENT_ACCOUNTABILITY
  VIEW_INCIDENT_LOGS
  EXPORT_DATA
  COMMUNICATE_STAFF
  VIEW_TIPS
}

enum ResponderUserStatus {
  ACTIVE_RESPONDER
  DISABLED_RESPONDER
}

model SchoolAgencyLink {
  id          String             @id @default(uuid())
  siteId      String             @map("site_id")
  agencyId    String             @map("agency_id")
  accessLevel AgencyAccessLevel
  approvedBy  String?            @map("approved_by")
  approvedAt  DateTime?          @map("approved_at")
  mouSigned   Boolean            @default(false) @map("mou_signed")
  expiresAt   DateTime?          @map("expires_at")
  status      SchoolAgencyStatus @default(ACTIVE_LINK)
  createdAt   DateTime           @default(now()) @map("created_at")

  site   Site   @relation(fields: [siteId], references: [id])
  agency Agency @relation(fields: [agencyId], references: [id])

  @@unique([siteId, agencyId])
  @@map("school_agency_links")
}

enum AgencyAccessLevel {
  PRE_INCIDENT
  FULL_RESPONSE
  INVESTIGATION
}

enum SchoolAgencyStatus {
  ACTIVE_LINK
  EXPIRED_LINK
  REVOKED_LINK
}

// ============================================================================
// First Responder Module — Incidents
// ============================================================================

model Incident {
  id                       String           @id @default(uuid())
  siteId                   String           @map("site_id")
  type                     IncidentType
  status                   IncidentStatus   @default(TRIGGERED_INCIDENT)
  severity                 IncidentSeverity @default(HIGH_INCIDENT)
  triggeredBy              String?          @map("triggered_by")
  triggeredAt              DateTime         @default(now()) @map("triggered_at")
  triggerDeviceId          String?          @map("trigger_device_id")
  triggerBuildingId        String?          @map("trigger_building_id")
  triggerFloor             Int?             @map("trigger_floor")
  triggerRoom              String?          @map("trigger_room")
  triggerLat               Float?           @map("trigger_lat")
  triggerLng               Float?           @map("trigger_lng")
  dispatchedAt             DateTime?        @map("dispatched_at")
  firstResponderArrival    DateTime?        @map("first_responder_arrival")
  allClearAt               DateTime?        @map("all_clear_at")
  reunificationStartedAt   DateTime?        @map("reunification_started_at")
  reunificationCompletedAt DateTime?        @map("reunification_completed_at")
  resolvedAt               DateTime?        @map("resolved_at")
  resolvedBy               String?          @map("resolved_by")
  notes                    String?
  createdAt                DateTime         @default(now()) @map("created_at")
  updatedAt                DateTime         @updatedAt @map("updated_at")

  site                  Site                   @relation(fields: [siteId], references: [id])
  timeline              IncidentTimeline[]
  respondingAgencies    IncidentAgency[]
  messages              SecureMessage[]
  videoBookmarks        VideoBookmark[]
  doorCommands          DoorCommand[]
  frReunificationEvents FRReunificationEvent[]
  rollCalls             RollCall[]
  afterActionReport     AfterActionReport?

  @@index([siteId])
  @@index([status])
  @@index([siteId, status])
  @@map("incidents")
}

enum IncidentType {
  ACTIVE_THREAT
  LOCKDOWN_INCIDENT
  MEDICAL_INCIDENT
  FIRE_INCIDENT
  HAZMAT
  WEATHER_INCIDENT
  INTRUDER
  BOMB_THREAT
  OTHER_INCIDENT
}

enum IncidentStatus {
  TRIGGERED_INCIDENT
  DISPATCHED_INCIDENT
  RESPONDING_INCIDENT
  ON_SCENE
  ON_SCENE_INCIDENT
  LOCKDOWN_ACTIVE
  ALL_CLEAR_INCIDENT
  REUNIFICATION_INCIDENT
  RESOLVED_INCIDENT
  FALSE_ALARM
}

enum IncidentSeverity {
  CRITICAL_INCIDENT
  HIGH_INCIDENT
  MEDIUM_INCIDENT
  LOW_INCIDENT
}

model IncidentTimeline {
  id         String             @id @default(uuid())
  incidentId String             @map("incident_id")
  timestamp  DateTime           @default(now())
  action     String
  actionType TimelineActionType @map("action_type")
  actorType  String             @map("actor_type") // SYSTEM, STAFF, RESPONDER, ADMIN
  actorId    String?            @map("actor_id")
  metadata   Json?              @default("{}")
  createdAt  DateTime           @default(now()) @map("created_at")

  incident Incident @relation(fields: [incidentId], references: [id])

  @@index([incidentId, timestamp])
  @@map("incident_timeline")
}

enum TimelineActionType {
  PANIC_ACTIVATED
  DISPATCH_SENT
  DISPATCH_ACKNOWLEDGED
  LOCKDOWN_INITIATED
  DOOR_LOCKED
  DOOR_UNLOCKED
  DOOR_FORCED
  CAMERA_ACCESSED
  RESPONDER_EN_ROUTE
  RESPONDER_ON_SCENE
  NOTIFICATION_SENT
  ACCOUNTABILITY_UPDATE
  ALL_CLEAR_ACTION
  REUNIFICATION_STARTED
  STUDENT_RELEASED
  INCIDENT_RESOLVED
  NOTE_ADDED
  MESSAGE_SENT
  MESSAGE_RECEIVED
  FALSE_ALARM_DECLARED
  STATUS_CHANGE
  MANUAL_ENTRY
}

model IncidentAgency {
  incidentId     String    @map("incident_id")
  agencyId       String    @map("agency_id")
  notifiedAt     DateTime  @default(now()) @map("notified_at")
  acknowledgedAt DateTime? @map("acknowledged_at")
  onSceneAt      DateTime? @map("on_scene_at")

  incident Incident @relation(fields: [incidentId], references: [id])
  agency   Agency   @relation(fields: [agencyId], references: [id])

  @@id([incidentId, agencyId])
  @@map("incident_agencies")
}

// ============================================================================
// First Responder Module — Floor Plans & Facility Data
// ============================================================================

model FloorPlan {
  id           String   @id @default(uuid())
  siteId       String   @map("site_id")
  buildingId   String   @map("building_id")
  buildingName String   @map("building_name")
  floor        Int
  floorName    String   @map("floor_name")
  imageUrl     String   @map("image_url")
  imageWidth   Int      @map("image_width")
  imageHeight  Int      @map("image_height")
  updatedAt    DateTime @updatedAt @map("updated_at")
  createdAt    DateTime @default(now()) @map("created_at")

  site        Site                  @relation(fields: [siteId], references: [id])
  building    Building              @relation(fields: [buildingId], references: [id])
  devices     FloorPlanDevice[]
  annotations FloorPlanAnnotation[]

  @@index([siteId])
  @@index([buildingId])
  @@map("floor_plans")
}

model FloorPlanDevice {
  id       String          @id @default(uuid())
  planId   String          @map("plan_id")
  deviceId String          @map("device_id")
  type     FloorDeviceType
  label    String
  x        Float
  y        Float
  metadata Json?

  plan FloorPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@map("floor_plan_devices")
}

enum FloorDeviceType {
  FP_DOOR
  FP_CAMERA
  FP_PANIC_BUTTON_WALL
  FP_READER
  FP_INTERCOM
  FP_AED
  FP_FIRE_EXTINGUISHER
  FP_FIRE_PULL
  FP_FIRE_PANEL
  FP_UTILITY_SHUTOFF_ELECTRIC
  FP_UTILITY_SHUTOFF_GAS
  FP_UTILITY_SHUTOFF_WATER
  FP_FIRST_AID_KIT
  FP_RALLY_POINT
  FP_STAIRWELL
  FP_ELEVATOR
  FP_RESTROOM
  FP_OFFICE
  FP_HAZMAT_STORAGE
}

model FloorPlanAnnotation {
  id          String   @id @default(uuid())
  planId      String   @map("plan_id")
  type        String // TEXT, ZONE, PATH
  label       String?
  coordinates Json // [{x, y}] array
  color       String?
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  plan FloorPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@map("floor_plan_annotations")
}

model DataPackage {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  version     Int      @default(1)
  generatedAt DateTime @default(now()) @map("generated_at")
  generatedBy String?  @map("generated_by")
  contents    Json
  pdfUrl      String?  @map("pdf_url")
  createdAt   DateTime @default(now()) @map("created_at")

  site      Site                  @relation(fields: [siteId], references: [id])
  downloads DataPackageDownload[]

  @@index([siteId])
  @@map("data_packages")
}

model DataPackageDownload {
  id            String   @id @default(uuid())
  dataPackageId String   @map("data_package_id")
  downloadedBy  String   @map("downloaded_by")
  downloadedAt  DateTime @default(now()) @map("downloaded_at")
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")

  dataPackage   DataPackage   @relation(fields: [dataPackageId], references: [id])
  responderUser ResponderUser @relation(fields: [downloadedBy], references: [id])

  @@map("data_package_downloads")
}

model FRReunificationSite {
  id                 String   @id @default(uuid())
  siteId             String   @map("site_id")
  name               String
  address            String?
  isPrimary          Boolean  @default(false) @map("is_primary")
  capacity           Int?
  distanceFromSchool String?  @map("distance_from_school")
  drivingDirections  String?  @map("driving_directions")
  contactName        String?  @map("contact_name")
  contactPhone       String?  @map("contact_phone")
  parkingCapacity    Int?     @map("parking_capacity")
  notes              String?
  createdAt          DateTime @default(now()) @map("created_at")

  site                Site                   @relation(fields: [siteId], references: [id])
  reunificationEvents FRReunificationEvent[]

  @@index([siteId])
  @@map("fr_reunification_sites")
}

model StagingArea {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  name        String
  type        String // LAW_ENFORCEMENT, FIRE, EMS, COMMAND_POST, MEDIA
  description String?
  lat         Float?
  lng         Float?
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  site                    Site                            @relation(fields: [siteId], references: [id])
  reunificationAssignments ReunificationStagingAssignment[]

  @@index([siteId])
  @@map("staging_areas")
}

model KeyHolder {
  id            String   @id @default(uuid())
  siteId        String   @map("site_id")
  name          String
  role          String?
  phone         String?
  hasKeys       Boolean  @default(false) @map("has_keys")
  hasAccessCard Boolean  @default(false) @map("has_access_card")
  hasAlarmCode  Boolean  @default(false) @map("has_alarm_code")
  priority      Int      @default(99)
  createdAt     DateTime @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@map("key_holders")
}

model HazardLocation {
  id                  String   @id @default(uuid())
  siteId              String   @map("site_id")
  buildingId          String?  @map("building_id")
  type                String
  locationDescription String?  @map("location_description")
  floor               Int?
  description         String?
  sdsAvailable        Boolean  @default(false) @map("sds_available")
  createdAt           DateTime @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@map("hazard_locations")
}

// ============================================================================
// First Responder Module — Reunification (Enhanced)
// ============================================================================

model FRReunificationEvent {
  id                  String                @id @default(uuid())
  incidentId          String                @map("incident_id")
  siteId              String                @map("site_id")
  reunificationSiteId String?               @map("reunification_site_id")
  status              FRReunificationStatus @default(PREPARING)
  startedAt           DateTime              @default(now()) @map("started_at")
  completedAt         DateTime?             @map("completed_at")
  totalStudents       Int                   @default(0) @map("total_students")
  studentsAccounted   Int                   @default(0) @map("students_accounted")
  studentsReleased    Int                   @default(0) @map("students_released")
  studentsMissing     Int                   @default(0) @map("students_missing")
  studentsInjured     Int                   @default(0) @map("students_injured")
  updatedAt           DateTime              @updatedAt @map("updated_at")

  incident              Incident                      @relation(fields: [incidentId], references: [id])
  site                  Site                          @relation(fields: [siteId], references: [id])
  reunificationSite     FRReunificationSite?          @relation(fields: [reunificationSiteId], references: [id])
  guardianCheckIns      GuardianCheckIn[]
  studentReleases       StudentRelease[]
  qrCodes               ReunificationQRCode[]
  stagingAssignments    ReunificationStagingAssignment[]

  @@index([incidentId])
  @@index([siteId])
  @@map("fr_reunification_events")
}

enum FRReunificationStatus {
  PREPARING
  ACTIVE_REUNIFICATION
  WINDING_DOWN
  COMPLETED_REUNIFICATION
}

model GuardianCheckIn {
  id                   String   @id @default(uuid())
  reunificationEventId String   @map("reunification_event_id")
  guardianName         String   @map("guardian_name")
  guardianIdType       String?  @map("guardian_id_type")
  guardianIdLast4      String?  @map("guardian_id_last4")
  guardianIdVerified   Boolean  @default(false) @map("guardian_id_verified")
  requestedStudentIds  String[] @map("requested_student_ids")
  authorizedInSis      Boolean  @default(false) @map("authorized_in_sis")
  checkedInAt          DateTime @default(now()) @map("checked_in_at")
  checkedInBy          String?  @map("checked_in_by")
  status               String   @default("CHECKED_IN") // CHECKED_IN, WAITING, RELEASED, DENIED
  denyReason           String?  @map("deny_reason")

  reunificationEvent FRReunificationEvent @relation(fields: [reunificationEventId], references: [id])
  studentReleases    StudentRelease[]

  @@index([reunificationEventId])
  @@map("guardian_checkins")
}

model StudentRelease {
  id                   String   @id @default(uuid())
  reunificationEventId String   @map("reunification_event_id")
  studentId            String   @map("student_id")
  studentName          String   @map("student_name")
  guardianCheckInId    String?  @map("guardian_checkin_id")
  releasedTo           String   @map("released_to")
  releasedAt           DateTime @default(now()) @map("released_at")
  releasedBy           String?  @map("released_by")
  notes                String?

  reunificationEvent FRReunificationEvent @relation(fields: [reunificationEventId], references: [id])
  guardianCheckIn    GuardianCheckIn?     @relation(fields: [guardianCheckInId], references: [id])

  @@index([reunificationEventId])
  @@map("student_releases")
}

// ============================================================================
// First Responder Module — Tips (Enhanced)
// ============================================================================

model FRTip {
  id                  String        @id @default(uuid())
  trackingCode        String        @unique @map("tracking_code")
  siteId              String?       @map("site_id")
  source              FRTipSource
  category            FRTipCategory
  content             String
  attachments         String[]      @default([])
  tipsterContact      String?       @map("tipster_contact")
  isAnonymous         Boolean       @default(true) @map("is_anonymous")
  severity            TipSeverity   @default(MEDIUM)
  status              FRTipStatus   @default(NEW_TIP)
  assignedTo          String?       @map("assigned_to")
  escalatedToAgencyId String?       @map("escalated_to_agency_id")
  escalatedAt         DateTime?     @map("escalated_at")
  resolvedAt          DateTime?     @map("resolved_at")
  resolvedBy          String?       @map("resolved_by")
  resolution          String?
  publicStatusMessage String?       @map("public_status_message")
  timeline            Json          @default("[]")
  externalSourceId    String?       @map("external_source_id")
  externalSource      String?       @map("external_source")
  smsConversationId   String?       @map("sms_conversation_id")
  smsPhoneHash        String?       @map("sms_phone_hash")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  site              Site?         @relation(fields: [siteId], references: [id])
  escalatedToAgency Agency?       @relation("TipEscalatedToAgency", fields: [escalatedToAgencyId], references: [id])
  followUps         TipFollowUp[]

  @@index([siteId, status])
  @@index([severity])
  @@index([trackingCode])
  @@index([externalSource, externalSourceId])
  @@map("fr_tips")
}

enum FRTipSource {
  WEB_FORM
  MOBILE_APP_TIP
  TEXT_SMS
  PHONE_TIP
  EMAIL_TIP
  WEBHOOK_WETIP
  WEBHOOK_STOPIT
  WEBHOOK_SAY_SOMETHING
  WEBHOOK_CUSTOM
}

enum FRTipCategory {
  THREAT_OF_VIOLENCE
  WEAPON
  BULLYING_TIP
  DRUGS_TIP
  SELF_HARM_TIP
  SUSPICIOUS_PERSON
  SUSPICIOUS_PACKAGE
  INFRASTRUCTURE_TIP
  OTHER_TIP
}

enum FRTipStatus {
  NEW_TIP
  UNDER_REVIEW_TIP
  ESCALATED_TIP
  RESOLVED_TIP
  DISMISSED_TIP
}

model TipFollowUp {
  id          String   @id @default(uuid())
  tipId       String   @map("tip_id")
  source      String // TRACKING_PAGE, SMS, MOBILE_APP
  content     String
  attachments String[] @default([])
  createdAt   DateTime @default(now()) @map("created_at")

  tip FRTip @relation(fields: [tipId], references: [id])

  @@index([tipId, createdAt])
  @@map("tip_follow_ups")
}

model SmsTipConversation {
  id             String      @id @default(uuid())
  phoneHash      String      @map("phone_hash")
  phoneEncrypted String?     @map("phone_encrypted")
  state          SmsTipState @default(AWAITING_SCHOOL)
  siteId         String?     @map("site_id")
  category       String?
  content        String?
  tipId          String?     @map("tip_id")
  lastMessageAt  DateTime    @default(now()) @map("last_message_at")
  expiresAt      DateTime    @map("expires_at")
  createdAt      DateTime    @default(now()) @map("created_at")

  messages SmsTipMessage[]

  @@index([phoneHash, state])
  @@index([expiresAt])
  @@map("sms_tip_conversations")
}

enum SmsTipState {
  AWAITING_SCHOOL
  AWAITING_CATEGORY
  AWAITING_CONTENT
  AWAITING_CONFIRM
  COMPLETED_SMS
  EXPIRED_SMS
  CANCELLED_SMS
}

model SmsTipMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  direction      String // INBOUND, OUTBOUND
  body           String
  twilioSid      String?  @map("twilio_sid")
  status         String? // queued, sent, delivered, failed
  createdAt      DateTime @default(now()) @map("created_at")

  conversation SmsTipConversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId, createdAt])
  @@map("sms_tip_messages")
}

model TipWebhookConfig {
  id               String    @id @default(uuid())
  siteId           String    @map("site_id")
  source           String // wetip, stopit, saysomething, custom
  enabled          Boolean   @default(true)
  apiKey           String    @map("api_key")
  categoryMapping  Json      @default("{}") @map("category_mapping")
  defaultCategory  String    @default("OTHER_TIP") @map("default_category")
  schoolExternalId String?   @map("school_external_id")
  lastReceivedAt   DateTime? @map("last_received_at")
  totalReceived    Int       @default(0) @map("total_received")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@unique([siteId, source])
  @@map("tip_webhook_configs")
}

// ============================================================================
// First Responder Module — Secure Messaging
// ============================================================================

model SecureMessage {
  id            String    @id @default(uuid())
  incidentId    String    @map("incident_id")
  threadId      String    @map("thread_id")
  senderType    String    @map("sender_type") // STAFF, RESPONDER, SYSTEM
  senderId      String    @map("sender_id")
  senderName    String    @map("sender_name")
  recipientType String    @map("recipient_type") // STAFF, RESPONDER, BROADCAST
  recipientId   String?   @map("recipient_id")
  content       String
  messageType   String    @default("TEXT") @map("message_type") // TEXT, LOCATION_UPDATE, STATUS_UPDATE, IMAGE
  readAt        DateTime? @map("read_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  incident Incident @relation(fields: [incidentId], references: [id])
  // senderId is a plain string — can reference User (staff) or ResponderUser depending on senderType

  @@index([incidentId, threadId, createdAt])
  @@map("secure_messages")
}

// ============================================================================
// First Responder Module — Responder Audit Log
// ============================================================================

model ResponderAuditLog {
  id              String   @id @default(uuid())
  responderUserId String   @map("responder_user_id")
  action          String
  resourceType    String?  @map("resource_type")
  resourceId      String?  @map("resource_id")
  siteId          String?  @map("site_id")
  incidentId      String?  @map("incident_id")
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  metadata        Json?    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")

  responderUser ResponderUser @relation(fields: [responderUserId], references: [id])

  @@index([responderUserId, createdAt])
  @@index([siteId, createdAt])
  @@map("responder_audit_log")
}

// ============================================================================
// First Responder Module — Video Bookmarks
// ============================================================================

model VideoBookmark {
  id            String    @id @default(uuid())
  incidentId    String    @map("incident_id")
  cameraId      String    @map("camera_id")
  cameraName    String?   @map("camera_name")
  bookmarkStart DateTime  @map("bookmark_start")
  bookmarkEnd   DateTime? @map("bookmark_end")
  label         String?
  notes         String?
  createdBy     String    @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")

  incident      Incident      @relation(fields: [incidentId], references: [id])
  responderUser ResponderUser @relation(fields: [createdBy], references: [id])

  @@index([incidentId])
  @@map("video_bookmarks")
}

// ============================================================================
// First Responder Module — Gateway Redundancy
// ============================================================================

model Gateway {
  id                     String              @id @default(uuid())
  siteId                 String              @map("site_id")
  name                   String
  hostname               String?
  ipAddress              String?             @map("ip_address")
  macAddress             String?             @map("mac_address")
  hardwareModel          String?             @map("hardware_model")
  firmwareVersion        String?             @map("firmware_version")
  serialNumber           String?             @map("serial_number")
  clusterRole            GatewayClusterRole  @default(SINGLE) @map("cluster_role")
  clusterMode            GatewayClusterMode  @default(STANDALONE) @map("cluster_mode")
  clusterState           GatewayClusterState @default(SINGLE_GW) @map("cluster_state")
  partnerId              String?             @map("partner_id")
  assignedDevices        String[]            @default([]) @map("assigned_devices")
  assignedZones          String[]            @default([]) @map("assigned_zones")
  status                 GatewayStatus       @default(PROVISIONING_GW) @map("status")
  lastHeartbeatAt        DateTime?           @map("last_heartbeat_at")
  lastCloudSyncAt        DateTime?           @map("last_cloud_sync_at")
  cpuUsage               Int?                @map("cpu_usage")
  memoryUsage            Int?                @map("memory_usage")
  diskUsage              Int?                @map("disk_usage")
  uptimeSeconds          BigInt?             @map("uptime_seconds")
  bleDevicesConnected    Int                 @default(0) @map("ble_devices_connected")
  networkLatencyMs       Int?                @map("network_latency_ms")
  primaryConnection      String              @default("ETHERNET") @map("primary_connection")
  hasBackupCellular      Boolean             @default(false) @map("has_backup_cellular")
  cellularSignalStrength Int?                @map("cellular_signal_strength")
  provisioningToken      String?             @map("provisioning_token")
  authTokenHash          String?             @map("auth_token_hash")
  createdAt              DateTime            @default(now()) @map("created_at")
  updatedAt              DateTime            @updatedAt @map("updated_at")

  site             Site                   @relation(fields: [siteId], references: [id])
  partner          Gateway?               @relation("GatewayPair", fields: [partnerId], references: [id])
  pairedWith       Gateway[]              @relation("GatewayPair")
  heartbeats       GatewayHeartbeat[]
  failoversFailed  GatewayFailoverEvent[] @relation("FailedGateway")
  failoversAssumed GatewayFailoverEvent[] @relation("AssumingGateway")
  syncsSent        GatewayStateSync[]     @relation("SyncSource")
  syncsReceived    GatewayStateSync[]     @relation("SyncTarget")
  doorCommands     DoorCommand[]

  @@index([siteId])
  @@index([partnerId])
  @@index([status])
  @@map("gateways")
}

enum GatewayClusterRole {
  SINGLE
  PRIMARY_GW
  SECONDARY_GW
  ASSUMED_PRIMARY
}

enum GatewayClusterMode {
  STANDALONE
  ACTIVE_ACTIVE
  ACTIVE_PASSIVE
}

enum GatewayClusterState {
  HEALTHY_GW
  DEGRADED_GW
  FAILOVER_GW
  RECOVERING_GW
  SINGLE_GW
}

enum GatewayStatus {
  ONLINE_GW
  OFFLINE_GW
  DEGRADED_STATUS_GW
  UPDATING_GW
  PROVISIONING_GW
}

model GatewayHeartbeat {
  id                  String   @id @default(uuid())
  gatewayId           String   @map("gateway_id")
  timestamp           DateTime @default(now())
  status              String
  cpuUsage            Int?     @map("cpu_usage")
  memoryUsage         Int?     @map("memory_usage")
  bleDevicesConnected Int?     @map("ble_devices_connected")
  pendingCommands     Int      @default(0) @map("pending_commands")
  activeIncidentId    String?  @map("active_incident_id")
  firmwareVersion     String?  @map("firmware_version")

  gateway Gateway @relation(fields: [gatewayId], references: [id])

  @@index([gatewayId, timestamp(sort: Desc)])
  @@map("gateway_heartbeats")
}

model GatewayFailoverEvent {
  id                   String                @id @default(uuid())
  siteId               String                @map("site_id")
  failedGatewayId      String                @map("failed_gateway_id")
  assumingGatewayId    String                @map("assuming_gateway_id")
  failoverType         String                @map("failover_type") // AUTOMATIC, MANUAL
  reason               GatewayFailoverReason
  devicesTransferred   Int                   @default(0) @map("devices_transferred")
  failoverStartedAt    DateTime              @default(now()) @map("failover_started_at")
  failoverCompletedAt  DateTime?             @map("failover_completed_at")
  durationMs           Int?                  @map("duration_ms")
  incidentActiveAtTime Boolean               @default(false) @map("incident_active_at_time")
  recoveredAt          DateTime?             @map("recovered_at")
  rebalancedAt         DateTime?             @map("rebalanced_at")
  notes                String?
  createdAt            DateTime              @default(now()) @map("created_at")

  site            Site    @relation(fields: [siteId], references: [id])
  failedGateway   Gateway @relation("FailedGateway", fields: [failedGatewayId], references: [id])
  assumingGateway Gateway @relation("AssumingGateway", fields: [assumingGatewayId], references: [id])

  @@index([siteId, failoverStartedAt(sort: Desc)])
  @@map("gateway_failover_events")
}

enum GatewayFailoverReason {
  HEARTBEAT_TIMEOUT
  NETWORK_LOSS
  HARDWARE_FAILURE
  MANUAL_TRIGGER
  SOFTWARE_CRASH
  UPDATE_REBOOT
  PLANNED_MAINTENANCE
}

model GatewayStateSync {
  id               String   @id @default(uuid())
  sourceGatewayId  String   @map("source_gateway_id")
  targetGatewayId  String   @map("target_gateway_id")
  syncType         String   @map("sync_type") // FULL, DELTA
  payloadSizeBytes Int?     @map("payload_size_bytes")
  syncDurationMs   Int?     @map("sync_duration_ms")
  success          Boolean  @default(true)
  errorMessage     String?  @map("error_message")
  createdAt        DateTime @default(now()) @map("created_at")

  sourceGateway Gateway @relation("SyncSource", fields: [sourceGatewayId], references: [id])
  targetGateway Gateway @relation("SyncTarget", fields: [targetGatewayId], references: [id])

  @@index([sourceGatewayId, createdAt(sort: Desc)])
  @@map("gateway_state_syncs")
}


model DoorCommand {
  id            String    @id @default(uuid())
  doorId        String    @map("door_id")
  command       String // LOCK, UNLOCK
  issuedBy      String    @map("issued_by")
  issuedByType  String    @map("issued_by_type") // STAFF, RESPONDER, SYSTEM
  incidentId    String?   @map("incident_id")
  gatewayId     String    @map("gateway_id")
  status        String    @default("PENDING") // PENDING, EXECUTED, FAILED, TIMEOUT
  executedAt    DateTime? @map("executed_at")
  failureReason String?   @map("failure_reason")
  retryCount    Int       @default(0) @map("retry_count")
  maxRetries    Int       @default(3) @map("max_retries")
  timeoutAt     DateTime? @map("timeout_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  incident Incident? @relation(fields: [incidentId], references: [id])
  gateway  Gateway   @relation(fields: [gatewayId], references: [id])

  @@index([gatewayId, status])
  @@index([incidentId])
  @@map("door_commands")
}

// ============================================================================
// Event / Sports Scheduling with Door Access (Feature 1)
// ============================================================================

model Event {
  id                  String      @id @default(uuid())
  siteId              String      @map("site_id")
  name                String
  description         String?
  type                EventType
  startTime           DateTime    @map("start_time")
  endTime             DateTime    @map("end_time")
  recurrence          Json?
  schoolHoursOverride Boolean     @default(false) @map("school_hours_override")
  createdById         String      @map("created_by_id")
  status              EventStatus @default(SCHEDULED)
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  site       Site             @relation(fields: [siteId], references: [id])
  createdBy  User             @relation("EventCreatedBy", fields: [createdById], references: [id])
  doorGrants EventDoorGrant[]

  @@index([siteId, status])
  @@index([siteId, startTime])
  @@map("events")
}

model EventDoorGrant {
  id         String    @id @default(uuid())
  eventId    String    @map("event_id")
  doorId     String    @map("door_id")
  unlockAt   DateTime  @map("unlock_at")
  lockAt     DateTime  @map("lock_at")
  executed   Boolean   @default(false)
  failedAt   DateTime? @map("failed_at")
  failReason String?   @map("fail_reason")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  door  Door  @relation(fields: [doorId], references: [id])

  @@index([eventId])
  @@index([unlockAt])
  @@map("event_door_grants")
}

enum EventType {
  SPORTS
  ASSEMBLY
  CONCERT
  PARENT_NIGHT
  COMMUNITY
  MAINTENANCE
  OTHER_EVENT
}

enum EventStatus {
  SCHEDULED
  ACTIVE_EVENT
  COMPLETED_EVENT
  CANCELLED_EVENT
}

// ============================================================================
// Door Health Analytics & Work Orders (Feature 2)
// ============================================================================

model DoorHealthEvent {
  id            String        @id @default(uuid())
  doorId        String        @map("door_id")
  siteId        String        @map("site_id")
  eventType     DoorEventType @map("event_type")
  severity      String        // INFO, WARNING, CRITICAL
  detectedAt    DateTime      @map("detected_at")
  resolvedAt    DateTime?     @map("resolved_at")
  metadata      Json?
  autoWorkOrder Boolean       @default(false) @map("auto_work_order")

  door      Door       @relation(fields: [doorId], references: [id])
  site      Site       @relation(fields: [siteId], references: [id])
  workOrder WorkOrder? @relation("HealthEventWorkOrder")

  @@index([siteId, detectedAt])
  @@index([doorId, detectedAt])
  @@map("door_health_events")
}

model WorkOrder {
  id            String            @id @default(uuid())
  siteId        String            @map("site_id")
  doorId        String?           @map("door_id")
  healthEventId String?           @unique @map("health_event_id")
  title         String
  description   String?
  priority      WorkOrderPriority
  status        WorkOrderStatus   @default(OPEN)
  assignedTo    String?           @map("assigned_to")
  createdById   String?           @map("created_by_id")
  dueDate       DateTime?         @map("due_date")
  completedAt   DateTime?         @map("completed_at")
  notes         Json?
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  site        Site             @relation(fields: [siteId], references: [id])
  door        Door?            @relation(fields: [doorId], references: [id])
  healthEvent DoorHealthEvent? @relation("HealthEventWorkOrder", fields: [healthEventId], references: [id])

  @@index([siteId, status])
  @@index([siteId, priority])
  @@map("work_orders")
}

enum DoorEventType {
  FORCED_OPEN
  HELD_OPEN
  OFFLINE
  SLOW_RESPONSE
  BATTERY_LOW
  COMM_FAILURE
}

enum WorkOrderPriority {
  LOW_WO
  MEDIUM_WO
  HIGH_WO
  URGENT_WO
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS_WO
  COMPLETED_WO
  CANCELLED_WO
}

// ============================================================================
// System Heartbeat & Action Confirmation (Feature 3)
// ============================================================================

model ActionConfirmation {
  id            String             @id @default(uuid())
  siteId        String             @map("site_id")
  actionType    ActionType         @map("action_type")
  actionId      String             @map("action_id")
  status        ConfirmationStatus @default(PENDING_CONFIRMATION)
  initiatedById String?            @map("initiated_by_id")
  initiatedAt   DateTime           @map("initiated_at")
  confirmedAt   DateTime?          @map("confirmed_at")
  timeoutAt     DateTime           @map("timeout_at")
  escalatedAt   DateTime?          @map("escalated_at")
  escalationMsg String?            @map("escalation_msg")
  metadata      Json?

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
  @@index([timeoutAt])
  @@map("action_confirmations")
}

enum ActionType {
  LOCKDOWN_ACTION
  DISPATCH_911
  NOTIFICATION_ACTION
  DOOR_COMMAND_ACTION
  UNLOCK_EVENT
}

enum ConfirmationStatus {
  PENDING_CONFIRMATION
  CONFIRMED_ACTION
  PARTIAL_CONFIRMATION
  FAILED_CONFIRMATION
  TIMED_OUT_CONFIRMATION
}

// ============================================================================
// Teacher Accountability / Roll Call (Feature 4)
// ============================================================================

model RollCall {
  id                  String         @id @default(uuid())
  incidentId          String         @map("incident_id")
  siteId              String         @map("site_id")
  initiatedById       String         @map("initiated_by_id")
  initiatedAt         DateTime       @default(now()) @map("initiated_at")
  status              RollCallStatus @default(ACTIVE_ROLLCALL)
  totalClassrooms     Int            @map("total_classrooms")
  reportedClassrooms  Int            @default(0) @map("reported_classrooms")
  totalStudents       Int            @map("total_students")
  accountedStudents   Int            @default(0) @map("accounted_students")
  completedAt         DateTime?      @map("completed_at")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  incident Incident         @relation(fields: [incidentId], references: [id])
  site     Site             @relation(fields: [siteId], references: [id])
  reports  RollCallReport[]

  @@index([siteId, status])
  @@index([incidentId])
  @@map("roll_calls")
}

model RollCallReport {
  id              String   @id @default(uuid())
  rollCallId      String   @map("roll_call_id")
  userId          String   @map("user_id")
  roomId          String   @map("room_id")
  studentsPresent Int      @map("students_present")
  studentsAbsent  Int      @map("students_absent")
  studentsMissing String[] @map("students_missing")
  studentsInjured String[] @map("students_injured")
  notes           String?
  reportedAt      DateTime @default(now()) @map("reported_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  rollCall RollCall @relation(fields: [rollCallId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])
  room     Room     @relation(fields: [roomId], references: [id])

  @@unique([rollCallId, userId])
  @@index([rollCallId])
  @@map("roll_call_reports")
}

enum RollCallStatus {
  ACTIVE_ROLLCALL
  COMPLETED_ROLLCALL
  CANCELLED_ROLLCALL
}

// ============================================================================
// Integration Health Dashboard (Feature 5)
// ============================================================================

model IntegrationHealth {
  id              String            @id @default(uuid())
  siteId          String            @map("site_id")
  integrationName String            @map("integration_name")
  integrationType IntegrationType   @map("integration_type")
  status          IntegrationStatus @default(UNKNOWN_INTEGRATION)
  lastCheckAt     DateTime?         @map("last_check_at")
  lastSuccessAt   DateTime?         @map("last_success_at")
  lastErrorAt     DateTime?         @map("last_error_at")
  lastError       String?           @map("last_error")
  config          Json?
  metadata        Json?
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@unique([siteId, integrationName])
  @@index([siteId])
  @@map("integration_health")
}

enum IntegrationType {
  ACCESS_CONTROL_INT
  CAMERAS_INT
  DISPATCH_911_INT
  NOTIFICATIONS_INT
  VISITOR_MGMT_INT
  PANIC_DEVICES_INT
  WEAPONS_DETECTION_INT
  GUNSHOT_DETECTION_INT
  EDGE_SYNC_INT
  ENVIRONMENTAL_INT
}

enum IntegrationStatus {
  HEALTHY_INTEGRATION
  DEGRADED_INTEGRATION
  DOWN_INTEGRATION
  UNKNOWN_INTEGRATION
  DISABLED_INTEGRATION
}

// ============================================================================
// Visitor Ban List / Watchlist (Feature 6)
// ============================================================================

model VisitorBan {
  id          String    @id @default(uuid())
  siteId      String    @map("site_id")
  firstName   String    @map("first_name")
  lastName    String    @map("last_name")
  dateOfBirth DateTime? @map("date_of_birth")
  idNumber    String?   @map("id_number")
  reason      String
  bannedById  String    @map("banned_by_id")
  bannedAt    DateTime  @default(now()) @map("banned_at")
  expiresAt   DateTime? @map("expires_at")
  isActive    Boolean   @default(true) @map("is_active")
  photoUrl    String?   @map("photo_url")
  notes       String?
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  site     Site @relation(fields: [siteId], references: [id])
  bannedBy User @relation("BannedBy", fields: [bannedById], references: [id])

  @@index([siteId, lastName, firstName])
  @@index([siteId, isActive])
  @@map("visitor_bans")
}

// ============================================================================
// Fire Alarm Integration — NFPA 72 Positive Alarm Sequence (PAS) Protocol
// ============================================================================

model FireAlarmZone {
  id               String              @id @default(uuid())
  siteId           String              @map("site_id")
  buildingId       String?             @map("building_id")
  name             String
  zoneNumber       String              @map("zone_number")
  floor            Int?
  description      String?
  hasPullStations  Boolean             @default(true)  @map("has_pull_stations")
  hasSmokeDetectors Boolean            @default(true)  @map("has_smoke_detectors")
  hasHeatDetectors Boolean             @default(false) @map("has_heat_detectors")
  hasSprinklers    Boolean             @default(false) @map("has_sprinklers")
  mapX             Float?              @map("map_x")
  mapY             Float?              @map("map_y")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")

  site     Site              @relation(fields: [siteId], references: [id])
  events   FireAlarmEvent[]

  @@unique([siteId, zoneNumber])
  @@index([siteId])
  @@map("fire_alarm_zones")
}

model FireAlarmEvent {
  id                 String               @id @default(uuid())
  siteId             String               @map("site_id")
  alertId            String?              @map("alert_id")
  fireAlarmZoneId    String?              @map("fire_alarm_zone_id")
  deviceType         FireAlarmDeviceType  @map("device_type")
  status             FireAlarmEventStatus @default(ALARM_ACTIVE)
  suspicionLevel     FireAlarmSuspicion   @default(UNKNOWN_SUSPICION) @map("suspicion_level")
  acknowledgedAt     DateTime?            @map("acknowledged_at")
  acknowledgedById   String?              @map("acknowledged_by_id")
  investigationEndsAt DateTime?           @map("investigation_ends_at")
  decisionMadeAt     DateTime?            @map("decision_made_at")
  decisionMadeById   String?              @map("decision_made_by_id")
  decision           FireAlarmDecision?
  activeLockdownId   String?              @map("active_lockdown_id")
  notes              String?
  metadata           Json?
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")

  site           Site           @relation(fields: [siteId], references: [id])
  fireAlarmZone  FireAlarmZone? @relation(fields: [fireAlarmZoneId], references: [id])

  @@index([siteId, status])
  @@index([alertId])
  @@map("fire_alarm_events")
}

enum FireAlarmDeviceType {
  SMOKE_DETECTOR
  HEAT_DETECTOR
  MANUAL_PULL_STATION
  SPRINKLER_WATERFLOW
  DUCT_DETECTOR
  UNKNOWN_DEVICE
}

enum FireAlarmEventStatus {
  ALARM_ACTIVE
  ACKNOWLEDGED_ALARM
  INVESTIGATING
  CONFIRMED_FIRE
  FALSE_ALARM
  AUTO_ESCALATED
}

enum FireAlarmSuspicion {
  HIGH_SUSPICION       // Manual pull station during lockdown — likely ruse
  ELEVATED_SUSPICION   // Heat/waterflow — possible real fire
  MODERATE_SUSPICION   // Smoke detector near threat zone — likely gunfire
  LOW_SUSPICION        // Smoke detector away from threat — investigate
  UNKNOWN_SUSPICION
}

enum FireAlarmDecision {
  EVACUATE_ALL         // Confirmed fire — full building evacuation
  EVACUATE_DIRECTED    // Confirmed fire — evacuate specific zones away from threat
  MAINTAIN_LOCKDOWN    // False alarm — stay locked down
  EXTEND_INVESTIGATION // Active threat verified, holding beyond 3 minutes
}

// ============================================================================
// Directed Evacuation Routes
// ============================================================================

model EvacuationRoute {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  buildingId  String?  @map("building_id")
  name        String
  description String?
  fromZones   String[] @map("from_zones")
  toExit      String?  @map("to_exit")
  doorIds     String[] @map("door_ids")
  avoidZones  String[] @map("avoid_zones")
  isDefault   Boolean  @default(false) @map("is_default")
  mapPath     Json?    @map("map_path")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@map("evacuation_routes")
}

// ============================================================================
// BadgeKiosk Integration
// ============================================================================

model BadgeKioskIntegration {
  id              String    @id @default(uuid())
  siteId          String    @unique @map("site_id")
  apiUrl          String    @default("https://backend-production-345e.up.railway.app") @map("api_url")
  apiKey          String    @map("api_key")
  enabled         Boolean   @default(true)
  autoSync        Boolean   @default(true) @map("auto_sync")
  defaultTemplate String?   @map("default_template_id")
  defaultPrinter  String?   @map("default_printer_id")
  autoPrint       Boolean   @default(false) @map("auto_print")
  features        Json      @default("{}")
  lastSyncAt      DateTime? @map("last_sync_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@map("badgekiosk_integrations")
}

model BadgeGuardIntegration {
  id           String    @id @default(uuid())
  siteId       String    @unique @map("site_id")
  apiUrl       String    @default("https://badgeguard-production.up.railway.app") @map("api_url")
  apiKey       String    @map("api_key")
  deviceId     String?   @map("device_id")
  enabled      Boolean   @default(true)
  pushInterval Int       @default(300) @map("push_interval_seconds")
  lastPushAt   DateTime? @map("last_push_at")
  lastAlertAt  DateTime? @map("last_alert_at")
  alertCount   Int       @default(0) @map("alert_count")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@map("badgeguard_integrations")
}

// ============================================================================
// Threat Assessment Workflow — Case Management & Collaboration
// ============================================================================

model ThreatAssessmentTeamMember {
  id              String   @id @default(uuid())
  siteId          String   @map("site_id")
  threatReportId  String   @map("threat_report_id")
  userId          String   @map("user_id")
  role            ThreatTeamRole
  assignedAt      DateTime @default(now()) @map("assigned_at")
  acknowledgedAt  DateTime? @map("acknowledged_at")

  site         Site         @relation(fields: [siteId], references: [id])
  threatReport ThreatReport @relation(fields: [threatReportId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@unique([threatReportId, userId])
  @@index([siteId])
  @@index([threatReportId])
  @@map("threat_assessment_team_members")
}

enum ThreatTeamRole {
  LEAD_ASSESSOR
  COUNSELOR
  ADMINISTRATOR
  SRO          // School Resource Officer
  PSYCHOLOGIST
  SOCIAL_WORKER
  TEACHER_REP
  OBSERVER
}

model ThreatAssessmentNote {
  id              String   @id @default(uuid())
  siteId          String   @map("site_id")
  threatReportId  String   @map("threat_report_id")
  authorId        String   @map("author_id")
  noteType        ThreatNoteType @default(GENERAL)
  content         String
  isConfidential  Boolean  @default(false) @map("is_confidential")
  attachmentUrls  String[] @default([]) @map("attachment_urls")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  site         Site         @relation(fields: [siteId], references: [id])
  threatReport ThreatReport @relation(fields: [threatReportId], references: [id], onDelete: Cascade)
  author       User         @relation(fields: [authorId], references: [id])

  @@index([threatReportId, createdAt])
  @@index([siteId])
  @@map("threat_assessment_notes")
}

enum ThreatNoteType {
  GENERAL
  OBSERVATION
  INTERVIEW_SUMMARY
  PARENT_CONTACT
  LE_CONTACT       // Law enforcement contact
  COUNSELOR_NOTE
  FOLLOW_UP
  DECISION
  ESCALATION
}

model ThreatAssessmentInterview {
  id              String   @id @default(uuid())
  siteId          String   @map("site_id")
  threatReportId  String   @map("threat_report_id")
  conductedById   String   @map("conducted_by_id")
  intervieweeType IntervieweeType
  intervieweeName String   @map("interviewee_name")
  scheduledAt     DateTime? @map("scheduled_at")
  conductedAt     DateTime? @map("conducted_at")
  status          InterviewStatus @default(SCHEDULED)
  questions       Json?    // Structured interview questions
  responses       Json?    // Structured interview responses
  summary         String?
  riskIndicators  String[] @default([]) @map("risk_indicators")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  site         Site         @relation(fields: [siteId], references: [id])
  threatReport ThreatReport @relation(fields: [threatReportId], references: [id], onDelete: Cascade)
  conductedBy  User         @relation("InterviewConductedBy", fields: [conductedById], references: [id])

  @@index([threatReportId])
  @@index([siteId])
  @@map("threat_assessment_interviews")
}

enum IntervieweeType {
  SUBJECT
  VICTIM
  WITNESS
  PARENT_GUARDIAN
  TEACHER
  PEER
  STAFF
  OTHER
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model SafetyPlan {
  id              String   @id @default(uuid())
  siteId          String   @map("site_id")
  threatReportId  String   @map("threat_report_id")
  createdById     String   @map("created_by_id")
  planType        SafetyPlanType
  status          SafetyPlanStatus @default(DRAFT)
  objectives      Json     // Array of plan objectives
  interventions   Json     // Array of intervention steps
  monitoringPlan  Json?    @map("monitoring_plan") // Check-in schedule
  restrictions    Json?    // Campus restrictions, zone limits
  supportServices Json?    @map("support_services") // Referrals, counseling
  parentNotified  Boolean  @default(false) @map("parent_notified")
  parentNotifiedAt DateTime? @map("parent_notified_at")
  reviewDate      DateTime? @map("review_date")
  expiresAt       DateTime? @map("expires_at")
  approvedAt      DateTime? @map("approved_at")
  approvedById    String?  @map("approved_by_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  site         Site         @relation(fields: [siteId], references: [id])
  threatReport ThreatReport @relation(fields: [threatReportId], references: [id], onDelete: Cascade)
  createdBy    User         @relation(fields: [createdById], references: [id])

  @@index([threatReportId])
  @@index([siteId, status])
  @@map("safety_plans")
}

enum SafetyPlanType {
  BEHAVIORAL_CONTRACT
  SAFETY_ASSESSMENT
  RETURN_TO_SCHOOL
  MONITORING_PLAN
  INTERVENTION_PLAN
  CRISIS_PLAN
}

enum SafetyPlanStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  UNDER_REVIEW
  COMPLETED
  EXPIRED
}

model ThreatReportTipLink {
  id              String   @id @default(uuid())
  threatReportId  String   @map("threat_report_id")
  tipId           String   @map("tip_id")
  tipSource       String   @map("tip_source") // "anonymous_tip" or "fr_tip"
  linkedAt        DateTime @default(now()) @map("linked_at")
  linkedById      String   @map("linked_by_id")
  notes           String?

  threatReport ThreatReport @relation(fields: [threatReportId], references: [id], onDelete: Cascade)

  @@unique([threatReportId, tipId, tipSource])
  @@index([threatReportId])
  @@index([tipId])
  @@map("threat_report_tip_links")
}

// ============================================================================
// Enhanced Drill Management — Templates, Observations, Scoring, Recurring
// ============================================================================

model DrillTemplate {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  name            String
  type            DrillType
  description     String?
  objectives      Json?     // Array of drill objectives
  procedures      Json?     // Step-by-step procedure checklist
  requiredRoles   String[]  @default([]) @map("required_roles") // Roles that must participate
  estimatedDurationMin Int? @map("estimated_duration_min")
  scoringRubric   Json?     @map("scoring_rubric") // Evaluation criteria
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site   Site   @relation(fields: [siteId], references: [id])
  drills Drill[]

  @@index([siteId, type])
  @@map("drill_templates")
}

model DrillObservation {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  drillId     String   @map("drill_id")
  observerId  String   @map("observer_id")
  location    String?  // Area observed (e.g. "Building A, 2nd floor")
  category    DrillObservationCategory
  finding     String
  severity    DrillFindingSeverity @default(INFO)
  photoUrls   String[] @default([]) @map("photo_urls")
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now()) @map("created_at")

  site     Site  @relation(fields: [siteId], references: [id])
  drill    Drill @relation(fields: [drillId], references: [id], onDelete: Cascade)
  observer User  @relation(fields: [observerId], references: [id])

  @@index([drillId])
  @@index([siteId])
  @@map("drill_observations")
}

enum DrillObservationCategory {
  EVACUATION_PROCEDURE
  LOCKDOWN_PROCEDURE
  COMMUNICATION
  DOOR_SECURITY
  STUDENT_BEHAVIOR
  STAFF_RESPONSE
  TIMING
  ACCESSIBILITY
  EQUIPMENT
  OTHER
}

enum DrillFindingSeverity {
  INFO
  MINOR
  MAJOR
  CRITICAL
}

model DrillScore {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  drillId     String   @map("drill_id")
  scoredById  String   @map("scored_by_id")
  category    String   // Matches scoring rubric category from template
  score       Int      // 1-5 rating
  maxScore    Int      @default(5) @map("max_score")
  comments    String?
  createdAt   DateTime @default(now()) @map("created_at")

  site     Site  @relation(fields: [siteId], references: [id])
  drill    Drill @relation(fields: [drillId], references: [id], onDelete: Cascade)
  scoredBy User  @relation(fields: [scoredById], references: [id])

  @@unique([drillId, scoredById, category])
  @@index([drillId])
  @@index([siteId])
  @@map("drill_scores")
}

model RecurringDrillSchedule {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  templateId      String?   @map("template_id")
  type            DrillType
  frequency       DrillFrequency
  dayOfWeek       Int?      @map("day_of_week") // 0-6 for weekly
  dayOfMonth      Int?      @map("day_of_month") // 1-31 for monthly
  monthOfYear     Int?      @map("month_of_year") // 1-12 for specific months
  preferredTime   String?   @map("preferred_time") // HH:MM format
  buildingId      String?   @map("building_id")
  autoNotifyDays  Int       @default(7) @map("auto_notify_days") // Days before to notify staff
  isActive        Boolean   @default(true) @map("is_active")
  lastScheduledAt DateTime? @map("last_scheduled_at")
  nextScheduledAt DateTime? @map("next_scheduled_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site   Site   @relation(fields: [siteId], references: [id])
  drills Drill[]

  @@index([siteId, isActive])
  @@map("recurring_drill_schedules")
}

enum DrillFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
}

// ============================================================================
// Substitute & Contractor Tracking — Daily Access Passes & Training
// ============================================================================

model DailyAccessPass {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  email           String?
  phone           String?
  companyName     String?   @map("company_name")
  passType        AccessPassType
  purpose         String
  hostUserId      String?   @map("host_user_id")
  assignedZoneIds String[]  @default([]) @map("assigned_zone_ids")
  assignedRoomIds String[]  @default([]) @map("assigned_room_ids")
  validFrom       DateTime  @map("valid_from")
  validUntil      DateTime  @map("valid_until")
  checkedInAt     DateTime? @map("checked_in_at")
  checkedOutAt    DateTime? @map("checked_out_at")
  status          AccessPassStatus @default(PENDING)
  idVerified      Boolean   @default(false) @map("id_verified")
  backgroundCheck String?   @map("background_check") // CLEAR, PENDING, FLAGGED
  trainingVerified Boolean  @default(false) @map("training_verified")
  credentialId    String?   @map("credential_id") // Link to CardholderCredential
  visitorId       String?   @map("visitor_id") // Link to Visitor record
  badgeNumber     String?   @map("badge_number")
  notes           String?
  emergencyContact String?  @map("emergency_contact")
  emergencyPhone  String?   @map("emergency_phone")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])
  trainingRecords StaffTrainingRecord[]

  @@index([siteId, status])
  @@index([siteId, validFrom, validUntil])
  @@index([siteId, passType])
  @@map("daily_access_passes")
}

enum AccessPassType {
  SUBSTITUTE_TEACHER
  CONTRACTOR
  MAINTENANCE
  DELIVERY
  VOLUNTEER
  TEMPORARY_STAFF
}

enum AccessPassStatus {
  PENDING
  APPROVED
  ACTIVE        // Checked in
  EXPIRED
  REVOKED
  DENIED
}

model StaffTrainingRecord {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  accessPassId    String?   @map("access_pass_id")
  personName      String    @map("person_name")
  personEmail     String?   @map("person_email")
  trainingType    TrainingType @map("training_type")
  completedAt     DateTime? @map("completed_at")
  expiresAt       DateTime? @map("expires_at")
  certificateUrl  String?   @map("certificate_url")
  verified        Boolean   @default(false)
  verifiedById    String?   @map("verified_by_id")
  verifiedAt      DateTime? @map("verified_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  site       Site             @relation(fields: [siteId], references: [id])
  accessPass DailyAccessPass? @relation(fields: [accessPassId], references: [id], onDelete: SetNull)

  @@index([siteId, trainingType])
  @@index([accessPassId])
  @@map("staff_training_records")
}

enum TrainingType {
  SAFETY_ORIENTATION
  EMERGENCY_PROCEDURES
  ACTIVE_SHOOTER
  MANDATED_REPORTER
  STUDENT_SUPERVISION
  BUILDING_SPECIFIC
  HAZMAT
  FIRST_AID_CPR
  CUSTOM
}

// ============================================================================
// Student Wellness Check-In — Proactive Mental Health Monitoring
// ============================================================================

model WellnessCheckIn {
  id              String              @id @default(uuid())
  siteId          String              @map("site_id")
  studentId       String              @map("student_id")
  counselorId     String              @map("counselor_id")
  scheduleId      String?             @map("schedule_id")
  mood            WellnessMood
  riskFlags       String[]            @default([]) @map("risk_flags") // WITHDRAWN, AGGRESSION, SELF_HARM_INDICATORS, SUBSTANCE_USE, ANXIETY, PEER_CONFLICT
  academicConcern Boolean             @default(false) @map("academic_concern")
  attendanceConcern Boolean           @default(false) @map("attendance_concern")
  notes           String?
  isConfidential  Boolean             @default(false) @map("is_confidential")
  followUpNeeded  Boolean             @default(false) @map("follow_up_needed")
  followUpDate    DateTime?           @map("follow_up_date")
  referralMade    Boolean             @default(false) @map("referral_made")
  referralType    String?             @map("referral_type") // INTERNAL_COUNSELING, EXTERNAL_THERAPY, CRISIS_TEAM, ADMIN
  checkedInAt     DateTime            @default(now()) @map("checked_in_at")
  createdAt       DateTime            @default(now()) @map("created_at")

  site      Site              @relation(fields: [siteId], references: [id])
  student   Student           @relation(fields: [studentId], references: [id])
  counselor User              @relation("WellnessCheckInCounselor", fields: [counselorId], references: [id])
  schedule  WellnessSchedule? @relation(fields: [scheduleId], references: [id])

  @@index([siteId, studentId])
  @@index([siteId, counselorId])
  @@index([siteId, checkedInAt])
  @@index([studentId, checkedInAt])
  @@map("wellness_check_ins")
}

enum WellnessMood {
  EXCELLENT
  GOOD
  NEUTRAL
  LOW
  DISTRESSED
  CRISIS
}

model WellnessSchedule {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  studentId       String    @map("student_id")
  counselorId     String    @map("counselor_id")
  frequency       String    // DAILY, WEEKLY, BIWEEKLY, MONTHLY
  dayOfWeek       Int?      @map("day_of_week") // 0-6
  preferredTime   String?   @map("preferred_time") // HH:MM
  reason          String?
  priority        WellnessPriority @default(ROUTINE)
  isActive        Boolean   @default(true) @map("is_active")
  startDate       DateTime  @map("start_date")
  endDate         DateTime? @map("end_date")
  lastCheckInAt   DateTime? @map("last_check_in_at")
  nextCheckInAt   DateTime? @map("next_check_in_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site      Site              @relation(fields: [siteId], references: [id])
  student   Student           @relation(fields: [studentId], references: [id])
  counselor User              @relation("WellnessScheduleCounselor", fields: [counselorId], references: [id])
  checkIns  WellnessCheckIn[]

  @@unique([siteId, studentId, counselorId])
  @@index([siteId, isActive])
  @@index([siteId, nextCheckInAt])
  @@map("wellness_schedules")
}

enum WellnessPriority {
  ROUTINE
  ELEVATED
  HIGH
  URGENT
}

model WellnessIntervention {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  studentId       String    @map("student_id")
  counselorId     String    @map("counselor_id")
  type            InterventionType
  description     String
  outcome         String?
  parentNotified  Boolean   @default(false) @map("parent_notified")
  parentNotifiedAt DateTime? @map("parent_notified_at")
  externalReferral Boolean  @default(false) @map("external_referral")
  externalAgency  String?   @map("external_agency")
  status          InterventionStatus @default(PLANNED)
  scheduledAt     DateTime? @map("scheduled_at")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site      Site    @relation(fields: [siteId], references: [id])
  student   Student @relation(fields: [studentId], references: [id])
  counselor User    @relation("WellnessInterventionCounselor", fields: [counselorId], references: [id])

  @@index([siteId, studentId])
  @@index([siteId, status])
  @@map("wellness_interventions")
}

enum InterventionType {
  INDIVIDUAL_COUNSELING
  GROUP_COUNSELING
  PEER_MEDIATION
  BEHAVIORAL_PLAN
  PARENT_CONFERENCE
  CRISIS_INTERVENTION
  SUBSTANCE_ABUSE_REFERRAL
  EXTERNAL_THERAPY_REFERRAL
  CHECK_IN_ADJUSTMENT
  ACADEMIC_SUPPORT
}

enum InterventionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DEFERRED
}

// ============================================================================
// Student Attendance via Badge Access — Automated Attendance Tracking
// ============================================================================

model AttendanceRecord {
  id              String           @id @default(uuid())
  siteId          String           @map("site_id")
  studentId       String           @map("student_id")
  date            DateTime         @db.Date
  status          AttendanceStatus @default(ABSENT)
  firstScanAt     DateTime?        @map("first_scan_at")
  lastScanAt      DateTime?        @map("last_scan_at")
  totalScans      Int              @default(0) @map("total_scans")
  tardyMinutes    Int?             @map("tardy_minutes")
  earlyDepartureAt DateTime?       @map("early_departure_at")
  excused         Boolean          @default(false)
  excuseReason    String?          @map("excuse_reason")
  markedById      String?          @map("marked_by_id") // null = automated via badge scan
  overrideReason  String?          @map("override_reason")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  site    Site    @relation(fields: [siteId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([siteId, studentId, date])
  @@index([siteId, date])
  @@index([siteId, date, status])
  @@index([studentId, date])
  @@map("attendance_records")
}

enum AttendanceStatus {
  PRESENT
  TARDY
  ABSENT
  EARLY_DEPARTURE
  EXCUSED_ABSENT
}

model AttendanceScan {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  studentId       String?   @map("student_id")
  cardholderCredentialId String? @map("cardholder_credential_id")
  doorId          String?   @map("door_id")
  scanDirection   String?   @map("scan_direction") // ENTRY, EXIT
  cardNumber      String?   @map("card_number")
  facilityCode    String?   @map("facility_code")
  granted         Boolean   @default(true)
  scannedAt       DateTime  @default(now()) @map("scanned_at")

  site    Site    @relation(fields: [siteId], references: [id])

  @@index([siteId, scannedAt])
  @@index([siteId, studentId, scannedAt])
  @@index([cardNumber, scannedAt])
  @@map("attendance_scans")
}

model AttendanceConfig {
  id              String    @id @default(uuid())
  siteId          String    @unique @map("site_id")
  schoolStartTime String    @map("school_start_time") // HH:MM
  schoolEndTime   String    @map("school_end_time")   // HH:MM
  tardyThresholdMin Int     @default(10) @map("tardy_threshold_min") // Minutes after start = tardy
  absentThresholdMin Int    @default(120) @map("absent_threshold_min") // Minutes after start = absent
  autoMarkAbsent  Boolean   @default(true) @map("auto_mark_absent")
  scanDoorsOnly   String[]  @default([]) @map("scan_doors_only") // Door IDs that count for attendance
  excludeWeekends Boolean   @default(true) @map("exclude_weekends")
  excludeDates    DateTime[] @default([]) @map("exclude_dates") // Holidays, breaks
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@map("attendance_configs")
}

// ============================================================================
// Post-Incident After-Action Reports & Corrective Actions
// ============================================================================

model AfterActionReport {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  incidentId      String    @map("incident_id")
  authorId        String    @map("author_id")
  title           String
  executiveSummary String   @map("executive_summary")
  timelineSummary String?   @map("timeline_summary")
  whatWorked      Json?     @map("what_worked")      // Array of strengths
  whatFailed      Json?     @map("what_failed")       // Array of failures
  lessonsLearned  Json?     @map("lessons_learned")   // Array of lessons
  recommendations Json?     // Array of recommendations
  participantCount Int?     @map("participant_count")
  injuryCount     Int?      @map("injury_count")
  evacuationTimeS Int?      @map("evacuation_time_s")
  doorPerformance Json?     @map("door_performance")  // Summary of door lock/unlock data
  commPerformance Json?     @map("comm_performance")  // Communication effectiveness metrics
  status          AARStatus @default(DRAFT)
  reviewedById    String?   @map("reviewed_by_id")
  reviewedAt      DateTime? @map("reviewed_at")
  approvedById    String?   @map("approved_by_id")
  approvedAt      DateTime? @map("approved_at")
  publishedAt     DateTime? @map("published_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site             Site              @relation(fields: [siteId], references: [id])
  incident         Incident          @relation(fields: [incidentId], references: [id])
  author           User              @relation("AARAuthor", fields: [authorId], references: [id])
  correctiveActions CorrectiveAction[]

  @@unique([incidentId])
  @@index([siteId, status])
  @@index([siteId, createdAt])
  @@map("after_action_reports")
}

enum AARStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

model CorrectiveAction {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  afterActionReportId String @map("after_action_report_id")
  assigneeId      String?   @map("assignee_id")
  title           String
  description     String
  priority        CorrectiveActionPriority @default(MEDIUM)
  category        String?   // POLICY, TRAINING, EQUIPMENT, COMMUNICATION, PROCEDURE
  dueDate         DateTime? @map("due_date")
  status          CorrectiveActionStatus @default(OPEN)
  completedAt     DateTime? @map("completed_at")
  completionNotes String?   @map("completion_notes")
  verifiedById    String?   @map("verified_by_id")
  verifiedAt      DateTime? @map("verified_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site              Site              @relation(fields: [siteId], references: [id])
  afterActionReport AfterActionReport @relation(fields: [afterActionReportId], references: [id], onDelete: Cascade)

  @@index([afterActionReportId])
  @@index([siteId, status])
  @@index([siteId, dueDate])
  @@map("corrective_actions")
}

enum CorrectiveActionPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CorrectiveActionStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  VERIFIED
  CANCELLED
}

// ============================================================================
// Reunification QR Code Check-In & Staging Area Integration
// ============================================================================

model ReunificationQRCode {
  id                    String    @id @default(uuid())
  reunificationEventId  String    @map("reunification_event_id")
  guardianName          String    @map("guardian_name")
  guardianPhone         String?   @map("guardian_phone")
  guardianEmail         String?   @map("guardian_email")
  requestedStudentIds   String[]  @default([]) @map("requested_student_ids")
  qrToken               String    @unique @map("qr_token") // Unique scannable token
  isUsed                Boolean   @default(false) @map("is_used")
  usedAt                DateTime? @map("used_at")
  expiresAt             DateTime  @map("expires_at")
  generatedAt           DateTime  @default(now()) @map("generated_at")

  reunificationEvent FRReunificationEvent @relation(fields: [reunificationEventId], references: [id], onDelete: Cascade)

  @@index([reunificationEventId])
  @@index([qrToken])
  @@map("reunification_qr_codes")
}

model ReunificationStagingAssignment {
  id                    String    @id @default(uuid())
  reunificationEventId  String    @map("reunification_event_id")
  stagingAreaId         String    @map("staging_area_id")
  gradeLevel            String?   @map("grade_level")
  buildingId            String?   @map("building_id")
  studentCount          Int       @default(0) @map("student_count")
  staffAssignedIds      String[]  @default([]) @map("staff_assigned_ids")
  status                String    @default("PREPARING") // PREPARING, ACTIVE, CLEARED
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  reunificationEvent FRReunificationEvent @relation(fields: [reunificationEventId], references: [id], onDelete: Cascade)
  stagingArea        StagingArea          @relation(fields: [stagingAreaId], references: [id])

  @@unique([reunificationEventId, stagingAreaId, gradeLevel])
  @@index([reunificationEventId])
  @@map("reunification_staging_assignments")
}

// ============================================================================
// Classroom Audio Monitoring — Environmental Threat Detection via Microphones
// ============================================================================

model AudioSensor {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  buildingId      String    @map("building_id")
  roomId          String?   @map("room_id")
  name            String
  serialNumber    String?   @map("serial_number")
  manufacturer    String?
  model           String?
  firmwareVersion String?   @map("firmware_version")
  installLocation String?   @map("install_location") // "Room 101 ceiling", "Hallway B east"
  status          AudioSensorStatus @default(OFFLINE)
  sensitivity     Int       @default(75) // 0-100 sensitivity threshold
  enabledDetections String[] @default(["GUNSHOT", "FIRE_ALARM", "GLASS_BREAKING", "SCREAMING", "EXPLOSION"]) @map("enabled_detections")
  // Speech detection capabilities
  speechDetectionCapable Boolean @default(false) @map("speech_detection_capable") // hardware supports STT
  speechDetectionEnabled Boolean @default(false) @map("speech_detection_enabled") // admin toggled on
  sttModelVersion  String?  @map("stt_model_version") // "whisper-v3", "vosk-0.3.45", etc.
  lastHeartbeatAt DateTime? @map("last_heartbeat_at")
  lastCalibrationAt DateTime? @map("last_calibration_at")
  installedAt     DateTime? @map("installed_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site      Site                  @relation(fields: [siteId], references: [id])
  building  Building              @relation(fields: [buildingId], references: [id])
  events    AudioDetectionEvent[]
  speechEvents SpeechDetectionEvent[]

  @@index([siteId, status])
  @@index([siteId, buildingId])
  @@index([serialNumber])
  @@map("audio_sensors")
}

enum AudioSensorStatus {
  ONLINE
  OFFLINE
  CALIBRATING
  FAULT
  MAINTENANCE
}

model AudioDetectionEvent {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  sensorId        String    @map("sensor_id")
  detectionType   AudioDetectionType @map("detection_type")
  confidence      Float     // 0.0-1.0 confidence score from ML model
  decibelLevel    Float?    @map("decibel_level")
  durationMs      Int?      @map("duration_ms")
  audioClipUrl    String?   @map("audio_clip_url") // Stored audio snippet for review
  waveformData    Json?     @map("waveform_data")  // Audio signature data
  status          AudioEventStatus @default(UNREVIEWED)
  reviewedById    String?   @map("reviewed_by_id")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewNotes     String?   @map("review_notes")
  isConfirmed     Boolean?  @map("is_confirmed") // null = unreviewed, true/false = human verified
  incidentCreated Boolean   @default(false) @map("incident_created")
  incidentId      String?   @map("incident_id")
  alertSentAt     DateTime? @map("alert_sent_at")
  detectedAt      DateTime  @default(now()) @map("detected_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  site    Site        @relation(fields: [siteId], references: [id])
  sensor  AudioSensor @relation(fields: [sensorId], references: [id])

  @@index([siteId, detectedAt])
  @@index([siteId, detectionType])
  @@index([siteId, status])
  @@index([sensorId, detectedAt])
  @@map("audio_detection_events")
}

enum AudioDetectionType {
  GUNSHOT
  FIRE_ALARM
  GLASS_BREAKING
  SCREAMING
  EXPLOSION
  AGGRESSIVE_VOICE
  SMOKE_DETECTOR
  CARBON_MONOXIDE_ALARM
  PA_SYSTEM_ANOMALY
  UNKNOWN_THREAT
  // Speech/verbal keyword detection types
  VERBAL_FIRE_REPORT         // Someone yelling "fire", "something's burning", etc.
  VERBAL_WEAPON_REPORT       // Someone yelling "gun", "knife", "weapon", "shooter"
  VERBAL_MEDICAL_EMERGENCY   // "help", "call 911", "someone's hurt", "need a doctor"
  VERBAL_INTRUDER_REPORT     // "intruder", "someone broke in", "stranger"
  VERBAL_BOMB_THREAT         // "bomb", "explosive", "it's going to blow"
  VERBAL_FIGHT_REPORT        // "fight", "stop hitting", "they're fighting"
  VERBAL_GENERAL_DISTRESS    // Catch-all for other urgent verbal reports
}

enum AudioEventStatus {
  UNREVIEWED
  REVIEWING
  CONFIRMED_THREAT
  FALSE_POSITIVE
  ESCALATED
  RESOLVED
}

model AudioMonitorConfig {
  id                    String    @id @default(uuid())
  siteId                String    @unique @map("site_id")
  isEnabled             Boolean   @default(true) @map("is_enabled")
  autoAlertThreshold    Float     @default(0.85) @map("auto_alert_threshold") // Confidence level to auto-alert
  autoIncidentThreshold Float     @default(0.95) @map("auto_incident_threshold") // Confidence level to auto-create incident
  retentionDays         Int       @default(30) @map("retention_days") // Days to keep audio clips
  monitoringHours       Json?     @map("monitoring_hours") // { start: "07:00", end: "18:00" } or null for 24/7
  notifyChannels        String[]  @default(["DASHBOARD", "SMS"]) @map("notify_channels")
  escalationDelayS      Int       @default(30) @map("escalation_delay_s") // Seconds before auto-escalation
  enabledDetectionTypes String[]  @default(["GUNSHOT", "FIRE_ALARM", "GLASS_BREAKING", "SCREAMING", "EXPLOSION"]) @map("enabled_detection_types")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@map("audio_monitor_configs")
}

// ============================================================================
// Speech / Verbal Keyword Detection — Microphone-based Emergency Word Detection
// ============================================================================

/// Configurable keyword profiles that define what spoken words/phrases the
/// microphone system should listen for.  Each profile maps a category of
/// emergency to a set of keywords (multi-language) and detection parameters.
model SpeechKeywordProfile {
  id                String    @id @default(uuid())
  siteId            String    @map("site_id")
  name              String    // "Fire Keywords", "Medical Emergency Keywords"
  category          AudioDetectionType // links to VERBAL_* enum values
  language          String    @default("en") // ISO 639-1 language code
  keywords          String[]  // ["fire", "burning", "smoke", "something's on fire"]
  phrasePatterns    String[]  @default([]) @map("phrase_patterns") // regex/wildcard: ["*on fire*", "*call 911*"]
  minConfidence     Float     @default(0.70) @map("min_confidence") // confidence threshold for this profile
  priority          Int       @default(5) // 1=highest, 10=lowest
  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@unique([siteId, name])
  @@index([siteId, category])
  @@index([siteId, isActive])
  @@map("speech_keyword_profiles")
}

/// Individual speech detection events — captured when the on-device or
/// edge-server speech-to-text pipeline identifies a keyword/phrase match
/// from ambient audio.  Stores the transcript snippet, matched keyword,
/// and links back to the acoustic sensor and keyword profile that triggered it.
model SpeechDetectionEvent {
  id                String    @id @default(uuid())
  siteId            String    @map("site_id")
  sensorId          String    @map("sensor_id")
  keywordProfileId  String?   @map("keyword_profile_id")
  detectionType     AudioDetectionType @map("detection_type") // VERBAL_FIRE_REPORT, etc.
  transcript        String    // raw transcribed text snippet: "Oh my god there's a fire in the hallway"
  matchedKeywords   String[]  @map("matched_keywords") // ["fire", "hallway"]
  confidence        Float     // 0.0-1.0 overall speech recognition + keyword match confidence
  speechConfidence  Float?    @map("speech_confidence")  // STT model confidence separately
  keywordConfidence Float?    @map("keyword_confidence")  // keyword match confidence separately
  speakerCount      Int?      @map("speaker_count") // estimated number of speakers (panic indicator)
  emotionTag        String?   @map("emotion_tag") // "panic", "calm", "shouting", "crying"
  decibelLevel      Float?    @map("decibel_level")
  durationMs        Int?      @map("duration_ms") // length of speech segment
  audioClipUrl      String?   @map("audio_clip_url") // stored audio for review
  status            AudioEventStatus @default(UNREVIEWED)
  reviewedById      String?   @map("reviewed_by_id")
  reviewedAt        DateTime? @map("reviewed_at")
  reviewNotes       String?   @map("review_notes")
  isConfirmed       Boolean?  @map("is_confirmed")
  incidentCreated   Boolean   @default(false) @map("incident_created")
  incidentId        String?   @map("incident_id")
  alertSentAt       DateTime? @map("alert_sent_at")
  detectedAt        DateTime  @default(now()) @map("detected_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  site    Site        @relation(fields: [siteId], references: [id])
  sensor  AudioSensor @relation(fields: [sensorId], references: [id])

  @@index([siteId, detectedAt])
  @@index([siteId, detectionType])
  @@index([siteId, status])
  @@index([sensorId, detectedAt])
  @@map("speech_detection_events")
}

/// Per-site speech detection configuration — controls whether speech/verbal
/// keyword detection is enabled, which STT engine to use, privacy settings, etc.
model SpeechDetectionConfig {
  id                    String    @id @default(uuid())
  siteId                String    @unique @map("site_id")
  isEnabled             Boolean   @default(false) @map("is_enabled") // opt-in — disabled by default for privacy
  sttEngine             String    @default("ON_DEVICE") @map("stt_engine") // ON_DEVICE, EDGE_SERVER, CLOUD
  defaultLanguage       String    @default("en") @map("default_language")
  additionalLanguages   String[]  @default([]) @map("additional_languages") // multi-language support
  autoAlertThreshold    Float     @default(0.80) @map("auto_alert_threshold")
  autoIncidentThreshold Float     @default(0.92) @map("auto_incident_threshold")
  retainTranscripts     Boolean   @default(false) @map("retain_transcripts") // privacy: auto-delete transcripts after review?
  transcriptRetentionDays Int     @default(7) @map("transcript_retention_days")
  retainAudioClips      Boolean   @default(false) @map("retain_audio_clips")
  audioRetentionDays    Int       @default(3) @map("audio_retention_days")
  enableEmotionDetection Boolean  @default(true) @map("enable_emotion_detection")
  enableSpeakerCounting Boolean   @default(true) @map("enable_speaker_counting")
  monitoringHours       Json?     @map("monitoring_hours") // { start: "07:00", end: "18:00" } or null for 24/7
  enabledCategories     String[]  @default(["VERBAL_FIRE_REPORT", "VERBAL_WEAPON_REPORT", "VERBAL_MEDICAL_EMERGENCY", "VERBAL_INTRUDER_REPORT", "VERBAL_BOMB_THREAT"]) @map("enabled_categories")
  notifyChannels        String[]  @default(["DASHBOARD", "SMS"]) @map("notify_channels")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@map("speech_detection_configs")
}

// ============================================================================
// Scheduled Door Locks — Class Calendar & Automatic Door Locking
// ============================================================================

model ClassSchedule {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  name            String    // "Period 1", "Block A", "Homeroom"
  teacherId       String?   @map("teacher_id")
  roomId          String?   @map("room_id")
  dayOfWeek       Int[]     @map("day_of_week") // 0=Sun, 1=Mon, ..., 6=Sat — supports multiple days
  startTime       String    @map("start_time") // HH:MM
  endTime         String    @map("end_time")   // HH:MM
  semester        String?   // FALL, SPRING, SUMMER, YEAR_ROUND
  effectiveFrom   DateTime  @map("effective_from")
  effectiveUntil  DateTime? @map("effective_until")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site            Site               @relation(fields: [siteId], references: [id])
  doorLockSchedules DoorLockSchedule[]

  @@index([siteId, isActive])
  @@index([siteId, roomId])
  @@map("class_schedules")
}

model DoorLockSchedule {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  doorId          String    @map("door_id")
  classScheduleId String?   @map("class_schedule_id")
  lockAction      DoorLockAction @default(LOCK)
  offsetMinutes   Int       @default(10) @map("offset_minutes") // Minutes after class start to lock
  unlockBeforeEndMin Int    @default(2) @map("unlock_before_end_min") // Minutes before class end to unlock
  dayOfWeek       Int[]     @map("day_of_week") // Overrideable from class schedule
  lockTime        String?   @map("lock_time")   // HH:MM — if no class schedule linked, use manual time
  unlockTime      String?   @map("unlock_time") // HH:MM
  isActive        Boolean   @default(true) @map("is_active")
  lastExecutedAt  DateTime? @map("last_executed_at")
  lastAction      String?   @map("last_action") // LOCKED or UNLOCKED
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site          Site           @relation(fields: [siteId], references: [id])
  door          Door           @relation(fields: [doorId], references: [id])
  classSchedule ClassSchedule? @relation(fields: [classScheduleId], references: [id])

  @@unique([doorId, classScheduleId])
  @@index([siteId, isActive])
  @@index([doorId])
  @@map("door_lock_schedules")
}

enum DoorLockAction {
  LOCK
  UNLOCK
  LOCK_UNLOCK // Lock at start offset, unlock before end
}

model DoorScheduleOverride {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  doorId          String?   @map("door_id") // null = all doors at site
  overrideDate    DateTime  @db.Date @map("override_date")
  reason          String    // HOLIDAY, EARLY_DISMISSAL, SPECIAL_EVENT, EMERGENCY
  skipAllSchedules Boolean  @default(false) @map("skip_all_schedules")
  overrideLockTime String?  @map("override_lock_time")
  overrideUnlockTime String? @map("override_unlock_time")
  createdById     String    @map("created_by_id")
  createdAt       DateTime  @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, overrideDate])
  @@map("door_schedule_overrides")
}

// ============================================================================
// Emergency Supply Tracking — AEDs, First Aid Kits, Emergency Equipment
// ============================================================================

model EmergencySupply {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  buildingId      String?   @map("building_id")
  roomId          String?   @map("room_id")
  type            SupplyType
  name            String
  serialNumber    String?   @map("serial_number")
  manufacturer    String?
  model           String?
  location        String    // "Main Office hallway", "Gym entrance"
  floor           Int?
  mapX            Float?    @map("map_x")
  mapY            Float?    @map("map_y")
  status          SupplyStatus @default(OPERATIONAL)
  installedAt     DateTime? @map("installed_at")
  lastInspectedAt DateTime? @map("last_inspected_at")
  lastInspectedBy String?   @map("last_inspected_by")
  nextInspectionDue DateTime? @map("next_inspection_due")
  expiresAt       DateTime? @map("expires_at")
  warrantyExpires DateTime? @map("warranty_expires")
  notes           String?
  photoUrl        String?   @map("photo_url")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site        Site                   @relation(fields: [siteId], references: [id])
  items       SupplyItem[]
  inspections SupplyInspection[]
  usageLogs   SupplyUsageLog[]

  @@index([siteId, type])
  @@index([siteId, status])
  @@index([siteId, expiresAt])
  @@index([siteId, nextInspectionDue])
  @@map("emergency_supplies")
}

enum SupplyType {
  AED
  FIRST_AID_KIT
  FIRE_EXTINGUISHER
  TRAUMA_KIT
  STOP_THE_BLEED_KIT
  EMERGENCY_RADIO
  FLASHLIGHT
  BLANKET_KIT
  WATER_SUPPLY
  EVACUATION_CHAIR
  LOCKDOWN_KIT
  OTHER_SUPPLY
}

enum SupplyStatus {
  OPERATIONAL
  NEEDS_INSPECTION
  NEEDS_REPLACEMENT
  EXPIRED
  OUT_OF_SERVICE
  MISSING
  DEPLOYED
}

model SupplyItem {
  id              String    @id @default(uuid())
  supplyId        String    @map("supply_id")
  name            String    // "Adult pads", "Gauze 4x4", "Tourniquet"
  quantity        Int       @default(1)
  minQuantity     Int       @default(1) @map("min_quantity")
  expiresAt       DateTime? @map("expires_at")
  lotNumber       String?   @map("lot_number")
  isLow           Boolean   @default(false) @map("is_low")
  isExpired       Boolean   @default(false) @map("is_expired")
  lastCheckedAt   DateTime? @map("last_checked_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  supply EmergencySupply @relation(fields: [supplyId], references: [id], onDelete: Cascade)

  @@index([supplyId])
  @@index([expiresAt])
  @@map("supply_items")
}

model SupplyInspection {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  supplyId        String    @map("supply_id")
  inspectorId     String    @map("inspector_id")
  status          String    // PASS, FAIL, NEEDS_ATTENTION
  findings        String?
  photoUrls       String[]  @default([]) @map("photo_urls")
  itemsChecked    Json?     @map("items_checked") // { itemId: { ok: true, notes: "" } }
  nextDueAt       DateTime? @map("next_due_at")
  inspectedAt     DateTime  @default(now()) @map("inspected_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  site    Site            @relation(fields: [siteId], references: [id])
  supply  EmergencySupply @relation(fields: [supplyId], references: [id], onDelete: Cascade)

  @@index([supplyId, inspectedAt])
  @@index([siteId, inspectedAt])
  @@map("supply_inspections")
}

model SupplyUsageLog {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  supplyId        String    @map("supply_id")
  usedById        String?   @map("used_by_id")
  reason          String    // EMERGENCY, DRILL, INSPECTION, TRAINING
  description     String?
  incidentId      String?   @map("incident_id")
  itemsUsed       Json?     @map("items_used") // [{ itemName, quantityUsed }]
  replacementNeeded Boolean @default(true) @map("replacement_needed")
  replacedAt      DateTime? @map("replaced_at")
  usedAt          DateTime  @default(now()) @map("used_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  site   Site            @relation(fields: [siteId], references: [id])
  supply EmergencySupply @relation(fields: [supplyId], references: [id])

  @@index([supplyId, usedAt])
  @@index([siteId, usedAt])
  @@map("supply_usage_logs")
}

// ============================================================================
// Staff Certification Tracking — Expiration Alerts & Compliance Dashboard
// ============================================================================

model StaffCertification {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  userId          String    @map("user_id")
  type            CertificationType
  certName        String    @map("cert_name")
  issuedBy        String?   @map("issued_by")
  certNumber      String?   @map("cert_number")
  issuedAt        DateTime? @map("issued_at")
  expiresAt       DateTime? @map("expires_at")
  status          CertStatus @default(ACTIVE)
  certificateUrl  String?   @map("certificate_url")
  verified        Boolean   @default(false)
  verifiedById    String?   @map("verified_by_id")
  verifiedAt      DateTime? @map("verified_at")
  reminderSentAt  DateTime? @map("reminder_sent_at")
  renewalUrl      String?   @map("renewal_url")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([siteId, type])
  @@index([siteId, expiresAt])
  @@index([siteId, status])
  @@index([userId])
  @@map("staff_certifications")
}

enum CertificationType {
  CPR
  FIRST_AID
  AED_CERTIFIED
  ACTIVE_SHOOTER_TRAINING
  STOP_THE_BLEED
  MANDATED_REPORTER
  CPI_CRISIS_INTERVENTION
  FIRE_SAFETY
  HAZMAT
  SCHOOL_BUS_DRIVER
  SRO_CERTIFICATION
  MENTAL_HEALTH_FIRST_AID
  CUSTOM_CERT
}

enum CertStatus {
  ACTIVE
  EXPIRING_SOON
  EXPIRED
  REVOKED
  PENDING_VERIFICATION
}

model CertRequirement {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  type            CertificationType
  requiredForRoles String[] @default([]) @map("required_for_roles") // TEACHER, SITE_ADMIN, etc.
  renewalMonths   Int       @default(24) @map("renewal_months")
  reminderDaysBefore Int    @default(60) @map("reminder_days_before")
  isRequired      Boolean   @default(true) @map("is_required")
  description     String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@unique([siteId, type])
  @@map("cert_requirements")
}

// ============================================================================
// Compliance Auto-Alerts — Proactive Monitoring & Notifications
// ============================================================================

model ComplianceAlert {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  type            ComplianceAlertType
  severity        ComplianceAlertSeverity @default(WARNING)
  title           String
  description     String
  category        String?   // DRILL, SYSTEM, CERTIFICATION, REPORTING
  ruleReference   String?   @map("rule_reference") // "NJ P.L.2019 c.3", "FL HB 1421"
  dueDate         DateTime? @map("due_date")
  status          ComplianceAlertStatus @default(ACTIVE)
  acknowledgedById String?  @map("acknowledged_by_id")
  acknowledgedAt  DateTime? @map("acknowledged_at")
  resolvedAt      DateTime? @map("resolved_at")
  resolvedById    String?   @map("resolved_by_id")
  autoGenerated   Boolean   @default(true) @map("auto_generated")
  metadata        Json?     // Contextual data (drill counts, days remaining, etc.)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, status])
  @@index([siteId, type])
  @@index([siteId, severity, status])
  @@map("compliance_alerts")
}

enum ComplianceAlertType {
  DRILL_OVERDUE
  DRILL_QUOTA_AT_RISK
  SYSTEM_UPTIME_BELOW_THRESHOLD
  PANIC_DEVICE_OFFLINE
  CERT_EXPIRING
  CERT_EXPIRED
  DOOR_HEALTH_DEGRADED
  CAMERA_OFFLINE_EXTENDED
  NOTIFICATION_SYSTEM_FAILURE
  ANNUAL_REPORT_DUE
  STATE_AUDIT_APPROACHING
  SUPPLY_EXPIRED
  SUPPLY_LOW
  AED_INSPECTION_OVERDUE
}

enum ComplianceAlertSeverity {
  INFO
  WARNING
  URGENT
  CRITICAL
}

enum ComplianceAlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  SNOOZED
  ESCALATED
}

model ComplianceCheckSchedule {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  checkType       String    @map("check_type") // DRILL_QUOTA, SYSTEM_UPTIME, CERT_EXPIRY, SUPPLY_EXPIRY
  frequency       String    // DAILY, WEEKLY, MONTHLY
  lastRunAt       DateTime? @map("last_run_at")
  nextRunAt       DateTime? @map("next_run_at")
  isEnabled       Boolean   @default(true) @map("is_enabled")
  config          Json?     // Check-specific params { minDrillsPerMonth: 1, minUptimePct: 99 }
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@unique([siteId, checkType])
  @@index([nextRunAt])
  @@map("compliance_check_schedules")
}

// ============================================================================
// Video Intercom — Classroom-to-Office Door Verification
// ============================================================================

model IntercomDevice {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  buildingId      String    @map("building_id")
  doorId          String?   @map("door_id")
  roomId          String?   @map("room_id")
  name            String
  deviceType      IntercomDeviceType
  serialNumber    String?   @map("serial_number")
  ipAddress       String?   @map("ip_address")
  sipUri          String?   @map("sip_uri") // SIP address for VoIP intercom
  streamUrl       String?   @map("stream_url") // Video stream endpoint
  status          IntercomStatus @default(OFFLINE)
  hasCamera       Boolean   @default(true) @map("has_camera")
  hasSpeaker      Boolean   @default(true) @map("has_speaker")
  hasMicrophone   Boolean   @default(true) @map("has_microphone")
  hasDoorRelease  Boolean   @default(false) @map("has_door_release")
  lastOnlineAt    DateTime? @map("last_online_at")
  installedAt     DateTime? @map("installed_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site     Site     @relation(fields: [siteId], references: [id])
  building Building @relation(fields: [buildingId], references: [id])
  sessions IntercomSession[]

  @@index([siteId, status])
  @@index([siteId, buildingId])
  @@map("intercom_devices")
}

enum IntercomDeviceType {
  DOOR_STATION      // Exterior door with camera/speaker/mic
  CLASSROOM_STATION // Inside classroom
  OFFICE_STATION    // Front office / admin
  HALLWAY_STATION   // Corridor intercom
  GATE_STATION      // Parking lot / perimeter gate
}

enum IntercomStatus {
  ONLINE
  OFFLINE
  IN_CALL
  RINGING
  FAULT
}

model IntercomSession {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  callerDeviceId  String    @map("caller_device_id")
  receiverDeviceId String?  @map("receiver_device_id")
  answeredById    String?   @map("answered_by_id")
  sessionType     IntercomSessionType @default(CALL)
  status          IntercomSessionStatus @default(RINGING)
  startedAt       DateTime  @default(now()) @map("started_at")
  answeredAt      DateTime? @map("answered_at")
  endedAt         DateTime? @map("ended_at")
  doorReleased    Boolean   @default(false) @map("door_released")
  doorReleasedAt  DateTime? @map("door_released_at")
  doorReleasedById String?  @map("door_released_by_id")
  recordingUrl    String?   @map("recording_url")
  snapshotUrl     String?   @map("snapshot_url") // Photo captured during call
  visitorName     String?   @map("visitor_name")
  visitorPurpose  String?   @map("visitor_purpose")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")

  site         Site            @relation(fields: [siteId], references: [id])
  callerDevice IntercomDevice  @relation(fields: [callerDeviceId], references: [id])

  @@index([siteId, startedAt])
  @@index([callerDeviceId])
  @@index([siteId, status])
  @@map("intercom_sessions")
}

enum IntercomSessionType {
  CALL          // Standard two-way call
  DOOR_REQUEST  // Visitor requesting entry
  EMERGENCY     // Emergency intercom activation
  BROADCAST     // One-way announcement
}

enum IntercomSessionStatus {
  RINGING
  ACTIVE
  ON_HOLD
  COMPLETED
  MISSED
  REJECTED
}

// ============================================================================
// Perimeter Security — Fence Sensors, Vehicle Tracking, Breach Detection
// ============================================================================

model PerimeterSensor {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  name            String
  type            PerimeterSensorType
  zone            String?   // "North Fence Line", "Parking Lot A", "Loading Dock"
  lat             Float?
  lng             Float?
  serialNumber    String?   @map("serial_number")
  manufacturer    String?
  status          PerimeterSensorStatus @default(OFFLINE)
  sensitivity     Int       @default(75) // 0-100
  lastHeartbeatAt DateTime? @map("last_heartbeat_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site   Site                   @relation(fields: [siteId], references: [id])
  events PerimeterEvent[]

  @@index([siteId, type])
  @@index([siteId, status])
  @@map("perimeter_sensors")
}

enum PerimeterSensorType {
  FENCE_VIBRATION
  FENCE_CUT
  MOTION_DETECTOR
  BEAM_BREAK
  GROUND_SENSOR
  GATE_CONTACT
  LICENSE_PLATE_READER
  THERMAL_CAMERA
  RADAR
}

enum PerimeterSensorStatus {
  ONLINE
  OFFLINE
  TRIGGERED
  FAULT
  MAINTENANCE
}

model PerimeterEvent {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  sensorId        String    @map("sensor_id")
  eventType       PerimeterEventType @map("event_type")
  severity        String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  lat             Float?
  lng             Float?
  description     String?
  imageUrl        String?   @map("image_url")
  videoClipUrl    String?   @map("video_clip_url")
  vehiclePlate    String?   @map("vehicle_plate")
  vehicleDescription String? @map("vehicle_description")
  status          PerimeterEventStatus @default(UNREVIEWED)
  reviewedById    String?   @map("reviewed_by_id")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewNotes     String?   @map("review_notes")
  incidentId      String?   @map("incident_id")
  alertSentAt     DateTime? @map("alert_sent_at")
  detectedAt      DateTime  @default(now()) @map("detected_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  site   Site            @relation(fields: [siteId], references: [id])
  sensor PerimeterSensor @relation(fields: [sensorId], references: [id])

  @@index([siteId, detectedAt])
  @@index([siteId, eventType])
  @@index([siteId, status])
  @@index([sensorId, detectedAt])
  @@map("perimeter_events")
}

enum PerimeterEventType {
  FENCE_BREACH
  FENCE_TAMPER
  UNAUTHORIZED_VEHICLE
  UNKNOWN_VEHICLE
  LOITERING
  AFTER_HOURS_MOTION
  GATE_FORCED
  GATE_TAILGATING
  PERIMETER_CROSSING
  VEHICLE_SPEED
}

enum PerimeterEventStatus {
  UNREVIEWED
  REVIEWING
  CONFIRMED_THREAT
  FALSE_ALARM
  ESCALATED
  RESOLVED
}

model VehicleWhitelist {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  plateNumber     String    @map("plate_number")
  plateState      String?   @map("plate_state")
  ownerName       String?   @map("owner_name")
  ownerType       String?   @map("owner_type") // STAFF, PARENT, CONTRACTOR, DELIVERY
  vehicleMake     String?   @map("vehicle_make")
  vehicleModel    String?   @map("vehicle_model")
  vehicleColor    String?   @map("vehicle_color")
  vehicleYear     Int?      @map("vehicle_year")
  validFrom       DateTime? @map("valid_from")
  validUntil      DateTime? @map("valid_until")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@unique([siteId, plateNumber])
  @@index([siteId, isActive])
  @@index([plateNumber])
  @@map("vehicle_whitelist")
}

// ============================================================================
// BLE Beacon Location Tracking — Real-Time Student/Staff Positioning
// ============================================================================

model BLEBeacon {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  buildingId      String    @map("building_id")
  roomId          String?   @map("room_id")
  uuid            String    // iBeacon UUID
  major           Int       // iBeacon major value
  minor           Int       // iBeacon minor value
  name            String
  floor           Int       @default(1)
  lat             Float?
  lng             Float?
  mapX            Float?    @map("map_x")
  mapY            Float?    @map("map_y")
  txPower         Int       @default(-59) @map("tx_power") // Calibrated transmit power in dBm
  batteryLevel    Int?      @map("battery_level") // 0-100
  status          BLEBeaconStatus @default(ACTIVE)
  lastSeenAt      DateTime? @map("last_seen_at")
  installedAt     DateTime? @map("installed_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site     Site     @relation(fields: [siteId], references: [id])
  building Building @relation(fields: [buildingId], references: [id])

  @@unique([uuid, major, minor])
  @@index([siteId, buildingId])
  @@index([siteId, status])
  @@map("ble_beacons")
}

enum BLEBeaconStatus {
  ACTIVE
  LOW_BATTERY
  OFFLINE
  MAINTENANCE
}

model LocationPing {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  personType      String    @map("person_type") // STUDENT, STAFF, VISITOR
  personId        String    @map("person_id") // userId, studentId, or visitorId
  beaconUuid      String?   @map("beacon_uuid")
  beaconMajor     Int?      @map("beacon_major")
  beaconMinor     Int?      @map("beacon_minor")
  buildingId      String?   @map("building_id")
  roomId          String?   @map("room_id")
  floor           Int?
  rssi            Int?      // Signal strength at ping time
  accuracy        Float?    // Estimated distance in meters
  confidence      Float?    // 0.0-1.0
  lat             Float?
  lng             Float?
  pingedAt        DateTime  @default(now()) @map("pinged_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, personId, pingedAt])
  @@index([siteId, buildingId, pingedAt])
  @@index([siteId, pingedAt])
  @@map("location_pings")
}

model LocationSnapshot {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  personType      String    @map("person_type")
  personId        String    @map("person_id")
  buildingId      String?   @map("building_id")
  roomId          String?   @map("room_id")
  floor           Int?
  lat             Float?
  lng             Float?
  confidence      Float?
  lastSeenAt      DateTime  @map("last_seen_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@unique([siteId, personType, personId])
  @@index([siteId, buildingId])
  @@index([siteId, personType])
  @@map("location_snapshots")
}

// ============================================================================
// AI Video Analytics — Weapon Detection, Loitering, Unauthorized Access
// ============================================================================

model VideoAnalyticsConfig {
  id                    String    @id @default(uuid())
  siteId                String    @unique @map("site_id")
  isEnabled             Boolean   @default(true) @map("is_enabled")
  provider              String    @default("internal") // internal, zeroeyes, evolv, omnilert
  alertThreshold        Float     @default(0.80) @map("alert_threshold")
  autoIncidentThreshold Float     @default(0.95) @map("auto_incident_threshold")
  enabledDetectionTypes String[]  @default(["WEAPON", "LOITERING", "UNAUTHORIZED_ACCESS"]) @map("enabled_detection_types")
  processingFps         Int       @default(5) @map("processing_fps") // Frames per second to analyze
  retentionDays         Int       @default(30) @map("retention_days")
  notifyChannels        String[]  @default(["DASHBOARD", "SMS"]) @map("notify_channels")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  site Site @relation(fields: [siteId], references: [id])

  @@map("video_analytics_configs")
}

model VideoAnalyticsEvent {
  id              String    @id @default(uuid())
  siteId          String    @map("site_id")
  cameraId        String?   @map("camera_id") // Reference to external camera system
  cameraName      String?   @map("camera_name")
  detectionType   VideoDetectionType @map("detection_type")
  confidence      Float
  boundingBox     Json?     @map("bounding_box") // { x, y, width, height } in frame
  thumbnailUrl    String?   @map("thumbnail_url")
  videoClipUrl    String?   @map("video_clip_url")
  frameTimestamp  DateTime? @map("frame_timestamp")
  objectClass     String?   @map("object_class") // "handgun", "rifle", "knife", "person"
  objectAttributes Json?    @map("object_attributes") // { color, size, direction, speed }
  zone            String?   // Camera zone/region name
  status          VideoEventStatus @default(UNREVIEWED)
  reviewedById    String?   @map("reviewed_by_id")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewNotes     String?   @map("review_notes")
  isConfirmed     Boolean?  @map("is_confirmed")
  incidentCreated Boolean   @default(false) @map("incident_created")
  incidentId      String?   @map("incident_id")
  alertSentAt     DateTime? @map("alert_sent_at")
  detectedAt      DateTime  @default(now()) @map("detected_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  site Site @relation(fields: [siteId], references: [id])

  @@index([siteId, detectedAt])
  @@index([siteId, detectionType])
  @@index([siteId, status])
  @@map("video_analytics_events")
}

enum VideoDetectionType {
  WEAPON_FIREARM
  WEAPON_KNIFE
  WEAPON_OTHER
  LOITERING
  UNAUTHORIZED_ACCESS
  TAILGATING
  CROWD_FORMATION
  RUNNING
  FIGHT
  FALLEN_PERSON
  ABANDONED_OBJECT
  VEHICLE_WRONG_WAY
  FACE_MATCH_WATCHLIST
  PPE_VIOLATION
}

enum VideoEventStatus {
  UNREVIEWED
  REVIEWING
  CONFIRMED_THREAT
  FALSE_POSITIVE
  ESCALATED
  RESOLVED
}
